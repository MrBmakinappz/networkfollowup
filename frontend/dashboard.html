<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetworkFollowUp - Dashboard</title>
    <meta name="description" content="NetworkFollowUp - AI-Powered Follow-Up Automation for MLM">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåø</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Manrope', sans-serif;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            min-height: 100vh;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 32px 24px;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 48px;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 12px;
            color: #64748B;
            text-decoration: none;
            margin-bottom: 8px;
            transition: all 0.3s;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
        }

        .nav-item:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #10B981;
            transform: translateX(4px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .nav-icon {
            font-size: 20px;
        }

        .user-section {
            position: absolute;
            bottom: 32px;
            left: 24px;
            right: 24px;
            padding: 16px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 700;
            color: #1E293B;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-email {
            font-size: 12px;
            color: #64748B;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .logout-btn {
            background: none;
            border: none;
            color: #EF4444;
            cursor: pointer;
            font-size: 18px;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .main-content {
            margin-left: 280px;
            padding: 40px;
            min-height: 100vh;
        }

        .header {
            margin-bottom: 40px;
        }

        .welcome-text {
            font-size: 36px;
            font-weight: 800;
            color: white;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .welcome-subtext {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .stat-label {
            color: #64748B;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: #1E293B;
            line-height: 1;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 24px;
            font-weight: 800;
            color: #1E293B;
        }

        .card-subtitle {
            font-size: 14px;
            color: #64748B;
            margin-top: 4px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Manrope', sans-serif;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #10B981;
            border: 2px solid #10B981;
        }

        .btn-secondary:hover {
            background: #10B981;
            color: white;
        }

        .btn-success {
            background: #10B981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .section-content {
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* FOLLOW-UP MACHINE STYLES */
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .wizard-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #E2E8F0;
            z-index: 0;
        }

        .wizard-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
            z-index: 1;
            flex: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 3px solid #E2E8F0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #94A3B8;
            transition: all 0.3s;
        }

        .wizard-step.active .step-circle {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            border-color: #10B981;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .wizard-step.completed .step-circle {
            background: #10B981;
            border-color: #10B981;
            color: white;
        }

        .step-label {
            font-size: 13px;
            font-weight: 600;
            color: #94A3B8;
        }

        .wizard-step.active .step-label {
            color: #10B981;
        }

        .upload-zone {
            border: 3px dashed #CBD5E1;
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.03) 0%, rgba(118, 75, 162, 0.03) 100%);
        }

        .upload-zone:hover {
            border-color: #10B981;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
            transform: scale(1.01);
        }

        .upload-zone.dragover {
            border-color: #10B981;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
        }

        .customer-preview {
            background: #F8FAFC;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .customer-checkbox {
            width: 20px;
            height: 20px;
        }

        .customer-info {
            flex: 1;
        }

        .customer-name {
            font-weight: 700;
            color: #1E293B;
            margin-bottom: 4px;
        }

        .customer-details {
            font-size: 13px;
            color: #64748B;
        }

        .type-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .type-retail {
            background: rgba(59, 130, 246, 0.1);
            color: #3B82F6;
        }

        .type-wholesale {
            background: rgba(168, 85, 247, 0.1);
            color: #A855F7;
        }

        .type-advocates {
            background: rgba(245, 158, 11, 0.1);
            color: #F59E0B;
        }

        /* CUSTOMERS TABLE STYLES */
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #E2E8F0;
            background: white;
            color: #64748B;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .filter-btn:hover {
            border-color: #10B981;
            color: #10B981;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            border-color: #10B981;
            color: white;
        }

        .customers-table {
            width: 100%;
            border-collapse: collapse;
        }

        .customers-table th {
            text-align: left;
            padding: 12px;
            background: #F8FAFC;
            color: #64748B;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #E2E8F0;
        }

        .customers-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #F1F5F9;
            color: #475569;
        }

        .customers-table tr:hover {
            background: #F8FAFC;
        }

        .email-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .email-status.sent {
            background: rgba(16, 185, 129, 0.1);
            color: #10B981;
        }

        .email-status.pending {
            background: rgba(245, 158, 11, 0.1);
            color: #F59E0B;
        }

        .email-status.not-sent {
            background: rgba(148, 163, 184, 0.1);
            color: #94A3B8;
        }

        .country-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .country-card {
            padding: 16px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-radius: 12px;
            text-align: center;
        }

        .country-flag {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .country-name {
            font-weight: 700;
            color: #1E293B;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .country-count {
            font-size: 24px;
            font-weight: 800;
            color: #10B981;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #334155;
            font-weight: 600;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            font-family: 'Manrope', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #10B981;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .customer-type-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .type-option {
            padding: 20px;
            border: 2px solid #E2E8F0;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .type-option:hover {
            border-color: #10B981;
            transform: translateY(-2px);
        }

        .type-option.selected {
            border-color: #10B981;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .type-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .type-title {
            font-weight: 700;
            color: #1E293B;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .type-description {
            font-size: 12px;
            color: #64748B;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748B;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                padding: 24px;
            }
            
            .main-content {
                margin-left: 0;
                padding: 24px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .customer-type-selector {
                grid-template-columns: 1fr;
            }

            .wizard-steps {
                flex-direction: column;
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">NFU</div>
        
        <nav>
            <a class="nav-item active" onclick="showSection('dashboard', event)">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </a>
            <a class="nav-item" onclick="showSection('machine', event)">
                <span class="nav-icon">üöÄ</span>
                <span>Follow-Up Machine</span>
            </a>
            <a class="nav-item" onclick="showSection('customers', event)">
                <span class="nav-icon">üë•</span>
                <span>Customers</span>
            </a>
            <a class="nav-item" onclick="showSection('history', event)">
                <span class="nav-icon">üìú</span>
                <span>History</span>
            </a>
            <a class="nav-item" onclick="showSection('billing', event)">
                <span class="nav-icon">üí≥</span>
                <span>Billing</span>
            </a>
            <a class="nav-item" onclick="showSection('settings', event)">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </a>
        </nav>

        <div class="user-section">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-info">
                <div class="user-name" id="userName">Loading...</div>
                <div class="user-email" id="userEmail">Loading...</div>
            </div>
            <button class="logout-btn" onclick="logout()" title="Logout">üö™</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- DASHBOARD SECTION -->
        <div id="dashboard-section" class="section-content">
            <div class="header">
                <h1 class="welcome-text">Welcome back, <span id="welcomeName">User</span>! üëã</h1>
                <p class="welcome-subtext">Here's your team overview and recent activity</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-label">Total Customers</div>
                    <div class="stat-value" id="totalCustomers">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üìß</div>
                    <div class="stat-label">Emails Sent</div>
                    <div class="stat-value" id="totalEmails">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">‚úì</div>
                    <div class="stat-label">Follow-Ups Done</div>
                    <div class="stat-value" id="followUpsDone">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">‚è∞</div>
                    <div class="stat-label">Pending</div>
                    <div class="stat-value" id="pendingFollowUps">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üõçÔ∏è</div>
                    <div class="stat-label">Retail</div>
                    <div class="stat-value" id="retailCount">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üíº</div>
                    <div class="stat-label">Wholesale</div>
                    <div class="stat-value" id="wholesaleCount">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-label">Advocates</div>
                    <div class="stat-value" id="advocatesCount">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üåç</div>
                    <div class="stat-label">Countries</div>
                    <div class="stat-value" id="countriesCount">0</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 32px;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Emails Sent (Last 7 Days)</h2>
                    </div>
                    <div style="padding: 20px;">
                        <canvas id="emailsChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Revenue Trend (Last 30 Days)</h2>
                    </div>
                    <div style="padding: 20px;">
                        <canvas id="revenueChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Quick Start</h2>
                        <p class="card-subtitle">Get started with your follow-ups</p>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <button class="btn btn-primary" onclick="showSection('machine', event)">
                        üöÄ Launch Follow-Up Machine
                    </button>
                    <button class="btn btn-secondary" onclick="showSection('customers', event)">
                        üë• View Customers
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Customers by Country</h2>
                        <p class="card-subtitle">Your team distribution</p>
                    </div>
                </div>
                <div class="country-stats" id="countryStats">
                    <div class="empty-state">
                        <div class="empty-icon">üåç</div>
                        <p>No customers yet. Upload a screenshot to get started!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOLLOW-UP MACHINE SECTION -->
        <div id="machine-section" class="section-content" style="display: none;">
            <div class="header">
                <h1 class="welcome-text">Follow-Up Machine üöÄ</h1>
                <p class="welcome-subtext">Upload, extract, and send follow-up emails in minutes</p>
            </div>

            <div class="card">
                <div class="wizard-steps">
                    <div class="wizard-step active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Upload</div>
                    </div>
                    <div class="wizard-step" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Extract</div>
                    </div>
                    <div class="wizard-step" id="step3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Review</div>
                    </div>
                    <div class="wizard-step" id="step4">
                        <div class="step-circle">4</div>
                        <div class="step-label">Send</div>
                    </div>
                </div>

                <!-- Step 1: Upload -->
                <div id="machineStep1" class="machine-step">
                    <h3 style="margin-bottom: 20px; color: #1E293B;">Step 1: Upload Screenshot</h3>
                    <div class="upload-zone" id="machineUploadZone" onclick="document.getElementById('machineFileInput').click()">
                        <div style="font-size: 60px; margin-bottom: 16px;">üì∑</div>
                        <div style="font-size: 18px; font-weight: 600; color: #1E293B; margin-bottom: 8px;">
                            Click or drag to upload screenshot
                        </div>
                        <div style="font-size: 14px; color: #64748B;">
                            PNG, JPG up to 10MB ‚Ä¢ AI will extract customer data
                        </div>
                        <input type="file" id="machineFileInput" accept="image/*" style="display: none;" onchange="handleMachineUpload(event)">
                    </div>
                </div>

                <!-- Step 2: Extract (hidden initially) -->
                <div id="machineStep2" class="machine-step" style="display: none;">
                    <h3 style="margin-bottom: 20px; color: #1E293B;">Step 2: Extracting Data...</h3>
                    <div style="text-align: center; padding: 40px;">
                        <div style="font-size: 64px; margin-bottom: 16px;">ü§ñ</div>
                        <div style="font-size: 18px; font-weight: 600; color: #1E293B; margin-bottom: 8px;">
                            AI is analyzing your screenshot
                        </div>
                        <div style="font-size: 14px; color: #64748B;">
                            Extracting customer names, emails, types, and countries...
                        </div>
                    </div>
                </div>

                <!-- Step 3: Review (hidden initially) -->
                <div id="machineStep3" class="machine-step" style="display: none;">
                    <h3 style="margin-bottom: 20px; color: #1E293B;">Step 3: Review & Select Customers</h3>
                    <div style="margin-bottom: 16px;">
                        <button class="btn btn-sm btn-secondary" onclick="selectAllCustomers()">Select All</button>
                        <button class="btn btn-sm btn-secondary" onclick="deselectAllCustomers()">Deselect All</button>
                    </div>
                    <div id="extractedCustomers">
                        <!-- Dynamic customer list -->
                    </div>
                    <div style="margin-top: 24px;">
                        <button class="btn btn-primary" onclick="proceedToSend()">Continue to Send ‚Üí</button>
                    </div>
                </div>

                <!-- Step 4: Send (hidden initially) -->
                <div id="machineStep4" class="machine-step" style="display: none;">
                    <h3 style="margin-bottom: 20px; color: #1E293B;">Step 4: Choose Template & Send</h3>
                    
                    <div class="customer-type-selector">
                        <div class="type-option selected" onclick="selectTemplateType('retail')">
                            <div class="type-icon">üõçÔ∏è</div>
                            <div class="type-title">RETAIL</div>
                            <div class="type-description">For one-time buyers</div>
                        </div>
                        <div class="type-option" onclick="selectTemplateType('wholesale')">
                            <div class="type-icon">üíº</div>
                            <div class="type-title">WHOLESALE</div>
                            <div class="type-description">For discount members</div>
                        </div>
                        <div class="type-option" onclick="selectTemplateType('advocates')">
                            <div class="type-icon">‚≠ê</div>
                            <div class="type-title">ADVOCATES</div>
                            <div class="type-description">For team builders</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Email Subject</label>
                        <input type="text" id="sendSubject" value="Your doTERRA 25% Discount is Waiting!">
                    </div>

                    <div class="form-group">
                        <label>Email Body</label>
                        <textarea id="sendBody">Hi {{firstname}},

I'm {{your-name}}, your official doTERRA Wellness Advocate...

Variables: {{firstname}}, {{fullname}}, {{country}}, {{your-name}}, {{your-phone}}</textarea>
                    </div>

                    <div style="background: rgba(102, 126, 234, 0.1); padding: 16px; border-radius: 12px; margin-bottom: 24px;">
                        <strong style="color: #10B981;">üìß Ready to send to <span id="selectedCount">0</span> customers</strong>
                    </div>

                    <button class="btn btn-secondary" onclick="previewEmail()" style="margin-right: 12px;">
                        üëÅÔ∏è Preview Email
                    </button>
                    <button class="btn btn-primary btn-success" onclick="sendEmails()">
                        ‚úâÔ∏è Send Follow-Up Emails
                    </button>
                </div>
            </div>
        </div>

        <!-- CUSTOMERS SECTION -->
        <div id="customers-section" class="section-content" style="display: none;">
            <div class="header">
                <h1 class="welcome-text">Your Customers üë•</h1>
                <p class="welcome-subtext">Manage your team and track follow-ups</p>
            </div>

            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-label">Total</div>
                    <div class="stat-value" id="custTotalCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úì</div>
                    <div class="stat-label">Contacted</div>
                    <div class="stat-value" id="custContactedCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è∞</div>
                    <div class="stat-label">Pending</div>
                    <div class="stat-value" id="custPendingCount">0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Customer List</h2>
                        <p class="card-subtitle">Filter and manage your customers</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="openAddCustomerModal()">
                            ‚ûï Add Customer
                        </button>
                        <button class="btn btn-primary" onclick="showSection('machine', event)">
                            üì§ Upload Screenshot
                        </button>
                    </div>
                </div>

                <div class="filters">
                    <button class="filter-btn active" onclick="filterCustomers('all', event)">All</button>
                    <button class="filter-btn" onclick="filterCustomers('retail', event)">üõçÔ∏è Retail</button>
                    <button class="filter-btn" onclick="filterCustomers('wholesale', event)">üíº Wholesale</button>
                    <button class="filter-btn" onclick="filterCustomers('advocates', event)">‚≠ê Advocates</button>
                    <button class="filter-btn" onclick="filterCustomers('sent', event)">‚úì Email Sent</button>
                    <button class="filter-btn" onclick="filterCustomers('not-sent', event)">‚úó Not Contacted</button>
                </div>

                <div id="customersTableContainer">
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <p style="font-size: 16px; margin-bottom: 16px;">No customers yet</p>
                        <button class="btn btn-primary" onclick="showSection('machine', event)">
                            Upload Screenshot to Get Started
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- HISTORY SECTION -->
        <div id="history-section" class="section-content" style="display: none;">
            <div class="header">
                <h1 class="welcome-text">Email History üìú</h1>
                <p class="welcome-subtext">Track all sent follow-up emails</p>
            </div>

            <div class="card">
                <div class="empty-state">
                    <div class="empty-icon">üì≠</div>
                    <p style="font-size: 16px;">No emails sent yet</p>
                </div>
            </div>
        </div>

        <!-- BILLING SECTION -->
        <div id="billing-section" class="section-content" style="display: none;">
            <div class="header">
                <h1 class="welcome-text">Billing & Subscription üí≥</h1>
                <p class="welcome-subtext">Manage your plan and usage</p>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 16px; color: #1E293B;">Current Plan: <span style="color: #10B981;">Free</span></h3>
                <p style="color: #64748B; margin-bottom: 24px;">10 emails/month ‚Ä¢ 1 screenshot upload/month</p>
                <button class="btn btn-primary" onclick="alert('Upgrade coming soon!')">
                    ‚≠ê Upgrade to Pro - $29/month
                </button>
            </div>
        </div>

        <!-- SETTINGS SECTION -->
        <div id="settings-section" class="section-content" style="display: none;">
            <div class="header">
                <h1 class="welcome-text">Settings ‚öôÔ∏è</h1>
                <p class="welcome-subtext">Configure templates and preferences</p>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Email Templates</h2>
                        <p class="card-subtitle">Customize for each customer type</p>
                    </div>
                </div>

                <div class="customer-type-selector">
                    <div class="type-option selected">
                        <div class="type-icon">üõçÔ∏è</div>
                        <div class="type-title">RETAIL</div>
                        <div class="type-description">One-time customers</div>
                    </div>
                    <div class="type-option">
                        <div class="type-icon">üíº</div>
                        <div class="type-title">WHOLESALE</div>
                        <div class="type-description">Discount members</div>
                    </div>
                    <div class="type-option">
                        <div class="type-icon">‚≠ê</div>
                        <div class="type-title">ADVOCATES</div>
                        <div class="type-description">Team builders</div>
                    </div>
                </div>

                <div class="form-group">
                    <label>Subject</label>
                    <input type="text" value="Your doTERRA 25% Discount is Waiting!">
                </div>

                <div class="form-group">
                    <label>Body</label>
                    <textarea>Hi {{firstname}}...

Variables: {{firstname}}, {{fullname}}, {{country}}, {{your-name}}, {{your-phone}}</textarea>
                </div>

                <button class="btn btn-primary">üíæ Save Template</button>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Gmail Connection</h2>
                        <p class="card-subtitle">Connect to send emails</p>
                    </div>
                </div>
                <div style="margin-bottom: 16px;">
                    <span class="email-status not-sent">‚úó Not Connected</span>
                </div>
                <div id="gmailStatusContainer">
                    <span class="email-status not-sent" id="gmailStatus">‚úó Not Connected</span>
                </div>
                <button class="btn btn-primary" id="connectGmailBtn" onclick="connectGmail()">
                    ‚úâÔ∏è Connect Gmail
                </button>
            </div>
        </div>
    </div>

    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        /* Enhanced Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            max-width: 400px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .toast.show {
            display: flex;
            transform: translateX(0);
            opacity: 1;
        }

        .toast-icon {
            font-size: 20px;
            font-weight: bold;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: #1E293B;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #94A3B8;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .toast-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #1E293B;
        }

        .toast.error {
            border-left: 4px solid #EF4444;
        }

        .toast.error .toast-icon {
            color: #EF4444;
        }

        .toast.success {
            border-left: 4px solid #10B981;
        }

        .toast.success .toast-icon {
            color: #10B981;
        }

        .toast.info {
            border-left: 4px solid #3B82F6;
        }

        .toast.info .toast-icon {
            color: #3B82F6;
        }

        .toast.warning {
            border-left: 4px solid #F59E0B;
        }

        .toast.warning .toast-icon {
            color: #F59E0B;
        }

        /* Loading Skeletons */
        .skeleton {
            animation: skeleton-loading 1.5s ease-in-out infinite;
        }

        .skeleton-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            margin-bottom: 12px;
        }

        .skeleton-label {
            width: 60%;
            height: 14px;
            border-radius: 4px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            margin-bottom: 8px;
        }

        .skeleton-value {
            width: 40%;
            height: 24px;
            border-radius: 4px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        /* Success Animation */
        .success-checkmark {
            display: inline-block;
            font-size: 24px;
            animation: checkmark-pop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes checkmark-pop {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748B;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            color: #1E293B;
            margin-bottom: 8px;
        }

        .empty-message {
            font-size: 14px;
            margin-bottom: 24px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Confirmation Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .modal-content.danger .modal-header h3 {
            color: #EF4444;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #E2E8F0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: #1E293B;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #94A3B8;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #1E293B;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-body p {
            color: #64748B;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid #E2E8F0;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Ripple Effect */
        .btn {
            position: relative;
            overflow: hidden;
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: ripple-animation 0.6s;
            pointer-events: none;
        }

        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Smooth Transitions */
        body {
            transition: opacity 0.3s ease;
        }

        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-value {
            transition: all 0.3s ease;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>

    <div class="toast" id="toast"></div>

    <script>
        // Auto-detect environment: production or development
        const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
        const API_URL = isProduction 
            ? 'https://networkfollowup-production.up.railway.app/api'
            : 'http://localhost:5000/api';
        console.log('Environment:', isProduction ? 'PRODUCTION' : 'DEVELOPMENT');
        console.log('API URL:', API_URL);
        
        // Initialize Stripe
        // Note: In production, this should be loaded from environment variable or config
        // For now, using placeholder - replace with actual publishable key from Stripe Dashboard
        const STRIPE_PUBLISHABLE_KEY = 'pk_test_YOUR_STRIPE_PUBLISHABLE_KEY_HERE';
        const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
        
        let extractedData = [];
        let currentFilter = 'all';
        let allCustomers = []; // Store real customers from API

        function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                if (isProduction) {
                    window.location.href = 'https://networkfollowup.netlify.app/login.html';
                } else {
                    window.location.href = 'login.html';
                }
                return false;
            }
            
            // Check onboarding status
            const onboardingCompleted = localStorage.getItem('onboardingCompleted');
            if (onboardingCompleted !== 'true') {
                if (isProduction) {
                    window.location.href = 'https://networkfollowup.netlify.app/onboarding.html';
                } else {
                    window.location.href = 'onboarding.html';
                }
                return false;
            }
            
            return true;
        }

        function showToast(message, type = 'success', duration = 5000) {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            const icons = {
                success: '‚úì',
                error: '‚úï',
                info: '‚Ñπ',
                warning: '‚ö†'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.success}</div>
                <div class="toast-message">${message}</div>
                <button class="toast-close" onclick="this.parentElement.classList.remove('show')">√ó</button>
            `;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        function showConfirmationModal(options = {}) {
            const {
                title = 'Confirm Action',
                message = 'Are you sure you want to proceed?',
                confirmText = 'Confirm',
                cancelText = 'Cancel',
                onConfirm = () => {},
                onCancel = () => {},
                danger = false
            } = options;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content ${danger ? 'danger' : ''}">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <p>${message}</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove(); (${onCancel.toString()})()">${cancelText}</button>
                        <button class="btn ${danger ? 'btn-danger' : 'btn-primary'}" onclick="this.closest('.modal-overlay').remove(); (${onConfirm.toString()})()">${confirmText}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEsc);
                    onCancel();
                }
            };
            document.addEventListener('keydown', handleEsc);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                    onCancel();
                }
            });
        }

        function showEmptyState(container, options = {}) {
            const {
                icon = 'üì≠',
                title = 'No data yet',
                message = 'Get started by uploading your first screenshot',
                actionText = 'Upload Screenshot',
                onAction = () => {}
            } = options;
            
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">${icon}</div>
                    <h3 class="empty-title">${title}</h3>
                    <p class="empty-message">${message}</p>
                    ${actionText ? `<button class="btn btn-primary" onclick="(${onAction.toString()})()">${actionText}</button>` : ''}
                </div>
            `;
        }

        function showStatsLoading() {
            const statsGrid = document.querySelector('.stats-grid');
            if (!statsGrid) return;
            
            const skeleton = `
                <div class="stat-card skeleton">
                    <div class="skeleton-icon"></div>
                    <div class="skeleton-label"></div>
                    <div class="skeleton-value"></div>
                </div>
            `;
            
            statsGrid.innerHTML = Array(8).fill(skeleton).join('');
        }

        function showSuccessAnimation(element, message = 'Success!') {
            if (!element) return;
            
            const originalContent = element.innerHTML;
            const originalBg = element.style.background;
            
            element.innerHTML = '<span class="success-checkmark">‚úì</span>';
            element.style.background = 'linear-gradient(135deg, #10B981 0%, #059669 100%)';
            element.style.color = 'white';
            element.style.transform = 'scale(1.1)';
            
            setTimeout(() => {
                element.style.transform = 'scale(1)';
                showToast(message, 'success');
            }, 300);
            
            setTimeout(() => {
                element.innerHTML = originalContent;
                element.style.background = originalBg;
                element.style.color = '';
                element.style.transform = '';
            }, 2000);
        }

        function debounce(func, wait = 300) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Add ripple effect to buttons
        function addRippleEffect(button) {
            button.addEventListener('click', function(e) {
                const ripple = document.createElement('span');
                const rect = this.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                ripple.classList.add('ripple');
                
                this.appendChild(ripple);
                
                setTimeout(() => {
                    ripple.remove();
                }, 600);
            });
        }

        function getAuthHeaders() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                console.error('‚ùå No auth token found in localStorage');
                showToast('Authentication failed - Please log in again', 'error');
                // Redirect to login
                setTimeout(() => {
                    if (isProduction) {
                        window.location.href = 'https://networkfollowup.netlify.app/login.html';
                    } else {
                        window.location.href = 'login.html';
                    }
                }, 2000);
                return {
                    'Content-Type': 'application/json'
                };
            }
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        async function connectGmail() {
            try {
                const btn = document.getElementById('connectGmailBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> Connecting...';

                // Redirect to OAuth URL (production or development)
                const oauthUrl = isProduction
                    ? 'https://networkfollowup-production.up.railway.app/api/oauth/google'
                    : 'http://localhost:5000/api/oauth/google';
                console.log('Redirecting to:', oauthUrl);
                window.location.href = oauthUrl;
            } catch (error) {
                console.error('Connect Gmail error:', error);
                showToast('Failed to connect Gmail. Please try again.', 'error');
                document.getElementById('connectGmailBtn').disabled = false;
                document.getElementById('connectGmailBtn').innerHTML = '‚úâÔ∏è Connect Gmail';
            }
        }

        async function checkGmailStatus() {
            try {
                const response = await fetch(`${API_URL}/emails/gmail-status`, {
                    headers: getAuthHeaders()
                });

                const data = await response.json();

                if (data.success && data.connected) {
                    document.getElementById('gmailStatus').textContent = `‚úì Connected: ${data.email}`;
                    document.getElementById('gmailStatus').className = 'email-status sent';
                    document.getElementById('connectGmailBtn').textContent = '‚úì Gmail Connected';
                    document.getElementById('connectGmailBtn').disabled = true;
                } else {
                    document.getElementById('gmailStatus').textContent = '‚úó Not Connected';
                    document.getElementById('gmailStatus').className = 'email-status not-sent';
                }
            } catch (error) {
                console.error('Gmail status check error:', error);
            }
        }

        async function loadDashboard() {
            if (!checkAuth()) return;

            const userName = localStorage.getItem('userName') || 'User';
            const userEmail = localStorage.getItem('userEmail') || '';
            
            document.getElementById('userName').textContent = userName;
            document.getElementById('userEmail').textContent = userEmail;
            document.getElementById('welcomeName').textContent = userName.split(' ')[0];
            document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();

            await checkGmailStatus();
            await loadDashboardStats();
            await loadCustomers();
        }

        // Chart instances
        let emailsChart = null;
        let revenueChart = null;

        async function loadDashboardStats() {
            // Show loading skeletons
            showStatsLoading();
            
            try {
                const response = await fetch(`${API_URL}/users/stats`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('Failed to load stats');
                }

                const data = await response.json();

                if (data.success && data.data) {
                    const stats = data.data;
                    const customers = stats.customers || {};
                    const emails = stats.emails || {};

                    // Animate stat updates
                    const animateValue = (element, start, end, duration) => {
                        if (!element) return;
                        const range = end - start;
                        const increment = range / (duration / 16);
                        let current = start;
                        
                        const timer = setInterval(() => {
                            current += increment;
                            if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                                element.textContent = end;
                                clearInterval(timer);
                            } else {
                                element.textContent = Math.floor(current);
                            }
                        }, 16);
                    };

                    // Update dashboard stats with animation
                    const totalCustomers = customers.total || 0;
                    const totalEmails = emails.sent || 0;
                    const pending = customers.pending || 0;
                    const retail = customers.retail || 0;
                    const wholesale = customers.wholesale || 0;
                    const advocates = customers.advocates || 0;
                    const countries = customers.countries || 0;

                    animateValue(document.getElementById('totalCustomers'), 0, totalCustomers, 500);
                    animateValue(document.getElementById('totalEmails'), 0, totalEmails, 500);
                    animateValue(document.getElementById('followUpsDone'), 0, totalEmails, 500);
                    animateValue(document.getElementById('pendingFollowUps'), 0, pending, 500);
                    animateValue(document.getElementById('retailCount'), 0, retail, 500);
                    animateValue(document.getElementById('wholesaleCount'), 0, wholesale, 500);
                    animateValue(document.getElementById('advocatesCount'), 0, advocates, 500);
                    animateValue(document.getElementById('countriesCount'), 0, countries, 500);

                    // Load charts
                    await loadCharts();

                    // Update country stats
                    if (stats.countryBreakdown && stats.countryBreakdown.length > 0) {
                        updateCountryStatsFromAPI(stats.countryBreakdown);
                    } else {
                        const container = document.getElementById('countryStats');
                        showEmptyState(container, {
                            icon: 'üåç',
                            title: 'No customers yet',
                            message: 'Upload a screenshot to extract customer data and see country breakdown',
                            actionText: 'Upload Screenshot',
                            onAction: () => showSection('machine', {target: {closest: () => null}})
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                // Show zeros on error
                document.getElementById('totalCustomers').textContent = '0';
                document.getElementById('totalEmails').textContent = '0';
                document.getElementById('followUpsDone').textContent = '0';
                document.getElementById('pendingFollowUps').textContent = '0';
                showToast('Failed to load dashboard stats', 'error');
            }
        }

        async function loadCharts() {
            try {
                // Get email history for last 7 days
                const emailResponse = await fetch(`${API_URL}/emails/history?limit=100`, {
                    headers: getAuthHeaders()
                });
                const emailData = await emailResponse.json();

                // Process email data for chart
                const last7Days = [];
                const emailCounts = {};
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    last7Days.push(dateStr);
                    emailCounts[dateStr] = 0;
                }

                if (emailData.success && emailData.data) {
                    emailData.data.forEach(email => {
                        if (email.sent_at) {
                            const dateStr = email.sent_at.split('T')[0];
                            if (emailCounts.hasOwnProperty(dateStr)) {
                                emailCounts[dateStr]++;
                            }
                        }
                    });
                }

                // Create emails chart
                const emailsCtx = document.getElementById('emailsChart');
                if (emailsCtx && typeof Chart !== 'undefined') {
                    if (emailsChart) emailsChart.destroy();
                    emailsChart = new Chart(emailsCtx, {
                        type: 'bar',
                        data: {
                            labels: last7Days.map(d => new Date(d).toLocaleDateString('en-US', { weekday: 'short' })),
                            datasets: [{
                                label: 'Emails Sent',
                                data: last7Days.map(d => emailCounts[d]),
                                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                borderColor: 'rgba(16, 185, 129, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }

                // Revenue chart (mock data - replace with real revenue data)
                const revenueCtx = document.getElementById('revenueChart');
                if (revenueCtx && typeof Chart !== 'undefined') {
                    const last30Days = [];
                    const revenueData = [];
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        last30Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                        // Mock revenue - replace with real data
                        revenueData.push(Math.random() * 1000 + 500);
                    }

                    if (revenueChart) revenueChart.destroy();
                    revenueChart = new Chart(revenueCtx, {
                        type: 'line',
                        data: {
                            labels: last30Days,
                            datasets: [{
                                label: 'Revenue ($)',
                                data: revenueData,
                                borderColor: 'rgba(16, 185, 129, 1)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }

        function updateCountryStatsFromAPI(countryBreakdown) {
            const flags = { USA: 'üá∫üá∏', DEU: 'üá©üá™', ESP: 'üá™üá∏', ITA: 'üáÆüáπ', FRA: 'üá´üá∑', GBR: 'üá¨üáß', CAN: 'üá®üá¶', AUS: 'üá¶üá∫' };
            const names = { 
                USA: 'USA', DEU: 'Germany', ESP: 'Spain', ITA: 'Italy', FRA: 'France',
                GBR: 'UK', CAN: 'Canada', AUS: 'Australia'
            };

            const html = countryBreakdown.map(item => `
                <div class="country-card">
                    <div class="country-flag">${flags[item.country_code] || 'üåç'}</div>
                    <div class="country-name">${names[item.country_code] || item.country_code}</div>
                    <div class="country-count">${item.count}</div>
                </div>
            `).join('');

            document.getElementById('countryStats').innerHTML = html || '<div class="empty-state"><div class="empty-icon">üåç</div><p>No customers yet</p></div>';
        }

        async function loadCustomers() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    console.error('‚ùå No auth token - cannot load customers');
                    return;
                }

                const response = await fetch(`${API_URL}/customers`, {
                    headers: getAuthHeaders()
                });

                if (response.status === 401 || response.status === 403) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('‚ùå Authentication failed:', errorData);
                    showToast('Authentication failed - Please log in again', 'error');
                    localStorage.clear();
                    setTimeout(() => {
                        if (isProduction) {
                            window.location.href = 'https://networkfollowup.netlify.app/login.html';
                        } else {
                            window.location.href = 'login.html';
                        }
                    }, 2000);
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to load customers');
                }

                const data = await response.json();

                if (data.success && data.data) {
                    // Transform API data to match expected format
                    allCustomers = data.data.map(c => ({
                        id: c.id,
                        name: c.full_name,
                        email: c.email,
                        type: c.member_type || c.customer_type,
                        country: c.country_code,
                        emailSent: c.last_contacted_at !== null || c.email_sent === true
                    }));

                    updateCustomersTable();
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                showToast('Failed to load customers. Please refresh.', 'error');
            }
        }

        // updateDashboardStats removed - now using loadDashboardStats() which loads from API

        function updateCustomersTable() {
            let filtered = allCustomers;
            
            if (currentFilter === 'retail') filtered = filtered.filter(c => c.type === 'retail');
            if (currentFilter === 'wholesale') filtered = filtered.filter(c => c.type === 'wholesale');
            if (currentFilter === 'advocates') filtered = filtered.filter(c => c.type === 'advocates');
            if (currentFilter === 'sent') filtered = filtered.filter(c => c.emailSent);
            if (currentFilter === 'not-sent') filtered = filtered.filter(c => !c.emailSent);

            document.getElementById('custTotalCount').textContent = allCustomers.length;
            document.getElementById('custContactedCount').textContent = allCustomers.filter(c => c.emailSent).length;
            document.getElementById('custPendingCount').textContent = allCustomers.filter(c => !c.emailSent).length;

            if (filtered.length === 0) {
                document.getElementById('customersTableContainer').innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><p>No customers match this filter</p></div>';
                return;
            }

            const html = `
                <table class="customers-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="selectAllCustomers" onchange="toggleSelectAllCustomers(this)"></th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Type</th>
                            <th>Country</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(c => `
                            <tr>
                                <td><input type="checkbox" class="customer-checkbox" data-customer-id="${c.id}" onchange="updateSelectedCustomers()"></td>
                                <td><strong>${c.name}</strong></td>
                                <td>${c.email}</td>
                                <td><span class="type-badge type-${c.type}">${c.type === 'retail' ? 'RETAIL' : c.type === 'wholesale' ? 'WHOLESALE' : 'ADVOCATES'}</span></td>
                                <td>${c.country || 'N/A'}</td>
                                <td>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-sm btn-secondary" onclick="openModifyCustomerModal('${c.id}')" style="padding: 6px 12px; font-size: 13px;">Edit</button>
                                        <button class="btn btn-sm btn-primary" onclick="openMessageCustomerModal('${c.id}')" style="padding: 6px 12px; font-size: 13px;">Message</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('customersTableContainer').innerHTML = html;
        }

        function filterCustomers(filter, event) {
            try {
                currentFilter = filter;
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                if (event && event.target) {
                    event.target.classList.add('active');
                }
                updateCustomersTable();
            } catch (error) {
                console.error('Error filtering customers:', error);
            }
        }

        function showSection(section, event) {
            try {
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                if (event && event.target) {
                    const navItem = event.target.closest('.nav-item');
                    if (navItem) navItem.classList.add('active');
                } else {
                    // Find nav item by section
                    document.querySelectorAll('.nav-item').forEach(item => {
                        if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(section)) {
                            item.classList.add('active');
                        }
                    });
                }

                document.querySelectorAll('.section-content').forEach(content => content.style.display = 'none');
                const targetSection = document.getElementById(section + '-section');
                if (targetSection) {
                    targetSection.style.display = 'block';
                } else {
                    console.error('Section not found:', section);
                }
            } catch (error) {
                console.error('Error showing section:', error);
            }
        }

        async function handleMachineUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Show step 2
            document.getElementById('machineStep1').style.display = 'none';
            document.getElementById('machineStep2').style.display = 'block';
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('active');

            try {
                // Upload screenshot to API
                const formData = new FormData();
                formData.append('screenshot', file);

                const response = await fetch(`${API_URL}/uploads/screenshot`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Convert API response to extractedData format
                    extractedData = data.data.customers.map(c => ({
                        id: c.id,
                        name: c.full_name,
                        email: c.email,
                        type: c.member_type || c.customer_type,
                        country: c.country_code,
                        selected: true
                    }));

                    showToast(`‚úÖ Extracted ${extractedData.length} customers from screenshot!`, 'success');
                    
                    // Auto-refresh customer list and show customers section
                    await loadCustomers();
                    showSection('customers', event);
                    showToast(`‚úÖ ${extractedData.length} customers added to list!`, 'success');
                } else {
                    throw new Error(data.message || data.error || 'Failed to extract customers');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showToast(error.message || 'Failed to upload screenshot. Please try again.', 'error');
                
                // Reset to step 1
                document.getElementById('machineStep2').style.display = 'none';
                document.getElementById('machineStep1').style.display = 'block';
                document.getElementById('step1').classList.remove('completed');
                document.getElementById('step1').classList.add('active');
                document.getElementById('step2').classList.remove('active');
            }
        }

        function showExtractedCustomers() {
            document.getElementById('machineStep2').style.display = 'none';
            document.getElementById('machineStep3').style.display = 'block';
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step3').classList.add('active');

            const html = extractedData.map((c, i) => `
                <div class="customer-preview">
                    <input type="checkbox" class="customer-checkbox" checked data-index="${i}">
                    <div class="customer-info">
                        <div class="customer-name">${c.name}</div>
                        <div class="customer-details">${c.email} ‚Ä¢ <span class="type-badge type-${c.type}">${c.type.toUpperCase()}</span> ‚Ä¢ ${c.country}</div>
                    </div>
                </div>
            `).join('');

            document.getElementById('extractedCustomers').innerHTML = html;
        }

        function selectAllCustomers() {
            document.querySelectorAll('.customer-checkbox').forEach(cb => cb.checked = true);
        }

        function deselectAllCustomers() {
            document.querySelectorAll('.customer-checkbox').forEach(cb => cb.checked = false);
        }

        function proceedToSend() {
            const selected = Array.from(document.querySelectorAll('.customer-checkbox:checked')).length;
            document.getElementById('selectedCount').textContent = selected;

            document.getElementById('machineStep3').style.display = 'none';
            document.getElementById('machineStep4').style.display = 'block';
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step3').classList.add('completed');
            document.getElementById('step4').classList.add('active');
        }

        let selectedTemplateType = 'retail';

        function selectTemplateType(type) {
            selectedTemplateType = type;
            document.querySelectorAll('#machineStep4 .type-option').forEach(opt => opt.classList.remove('selected'));
            event.target.closest('.type-option').classList.add('selected');
        }

        function previewEmail() {
            // Get selected customers
            const selectedCheckboxes = Array.from(document.querySelectorAll('.customer-checkbox:checked'));
            const selectedIndices = selectedCheckboxes.map(cb => parseInt(cb.dataset.index));
            const selectedCustomers = selectedIndices.map(i => extractedData[i]).filter(c => c);

            if (selectedCustomers.length === 0) {
                showToast('Please select at least one customer', 'error');
                return;
            }

            // Get subject and body
            const subject = document.getElementById('sendSubject').value;
            const body = document.getElementById('sendBody').value;

            if (!subject || !body) {
                showToast('Please fill in subject and body', 'error');
                return;
            }

            // Get user info for personalization
            const userName = localStorage.getItem('userName') || 'Your Advocate';

            // Use first customer for preview
            const previewCustomer = selectedCustomers[0];
            const firstName = previewCustomer.name.split(' ')[0];
            const fullName = previewCustomer.name;

            // Replace variables in subject and body
            const previewSubject = subject
                .replace(/\{\{firstname\}\}/g, firstName)
                .replace(/\{\{fullname\}\}/g, fullName)
                .replace(/\{\{email\}\}/g, previewCustomer.email)
                .replace(/\{\{country\}\}/g, previewCustomer.country || '')
                .replace(/\{\{your-name\}\}/g, userName)
                .replace(/\{\{your-phone\}\}/g, '');

            const previewBody = body
                .replace(/\{\{firstname\}\}/g, firstName)
                .replace(/\{\{fullname\}\}/g, fullName)
                .replace(/\{\{email\}\}/g, previewCustomer.email)
                .replace(/\{\{country\}\}/g, previewCustomer.country || '')
                .replace(/\{\{your-name\}\}/g, userName)
                .replace(/\{\{your-phone\}\}/g, '');

            // Show preview modal
            showEmailPreviewModal({
                subject: previewSubject,
                body: previewBody,
                customer: previewCustomer,
                totalCustomers: selectedCustomers.length,
                onSend: () => {
                    // Close preview and send
                    document.querySelector('.email-preview-modal')?.remove();
                    sendEmails();
                },
                onCancel: () => {
                    document.querySelector('.email-preview-modal')?.remove();
                }
            });
        }

        function showEmailPreviewModal(options) {
            const { subject, body, customer, totalCustomers, onSend, onCancel } = options;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay email-preview-modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>üìß Email Preview</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 20px; padding: 12px; background: #F8FAFC; border-radius: 8px;">
                            <strong>To:</strong> ${customer.email}<br>
                            <strong>Customer:</strong> ${customer.name}<br>
                            <strong>Total recipients:</strong> ${totalCustomers} customer${totalCustomers > 1 ? 's' : ''}
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1E293B;">Subject:</label>
                            <div style="padding: 12px; background: white; border: 1px solid #E2E8F0; border-radius: 8px; color: #1E293B;">
                                ${subject}
                            </div>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1E293B;">Body:</label>
                            <div style="padding: 16px; background: white; border: 1px solid #E2E8F0; border-radius: 8px; color: #1E293B; white-space: pre-wrap; line-height: 1.6; max-height: 400px; overflow-y: auto;">
                                ${body}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="(${onCancel.toString()})()">Cancel</button>
                        <button class="btn btn-primary" onclick="(${onSend.toString()})()">‚úâÔ∏è Send to ${totalCustomers} Customer${totalCustomers > 1 ? 's' : ''}</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on ESC
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEsc);
                    onCancel();
                }
            };
            document.addEventListener('keydown', handleEsc);

            // Close on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                    onCancel();
                }
            });
        }

        async function sendEmails() {
            try {
                // Get selected customers
                const selectedCheckboxes = Array.from(document.querySelectorAll('.customer-checkbox:checked'));
                const selectedIndices = selectedCheckboxes.map(cb => parseInt(cb.dataset.index));
                const selectedCustomers = selectedIndices.map(i => extractedData[i]).filter(c => c);

                if (selectedCustomers.length === 0) {
                    showToast('Please select at least one customer', 'error');
                    return;
                }

                // Get template type
                const templateType = selectedTemplateType;

                // Get subject and body
                const subject = document.getElementById('sendSubject').value;
                const body = document.getElementById('sendBody').value;

                if (!subject || !body) {
                    showToast('Please fill in subject and body', 'error');
                    return;
                }

                // Disable button and show loading
                const sendBtn = document.querySelector('#machineStep4 .btn-success');
                const originalText = sendBtn.innerHTML;
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<span class="spinner"></span> Sending emails...';

                let originalTextForError = originalText;

                // Send emails
                const response = await fetch(`${API_URL}/emails/send`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        customer_ids: selectedCustomers.map(c => c.id),
                        template_type: templateType,
                        language: 'en',
                        subject: subject,
                        body: body
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast(`Successfully sent ${data.data.success} emails!`, 'success');
                    
                    // Reset wizard
                    setTimeout(() => {
                        document.getElementById('machineStep4').style.display = 'none';
                        document.getElementById('machineStep1').style.display = 'block';
                        document.querySelectorAll('.wizard-step').forEach(step => {
                            step.classList.remove('active', 'completed');
                        });
                        document.getElementById('step1').classList.add('active');
                        document.getElementById('machineFileInput').value = '';
                        extractedData = [];
                    }, 2000);
                } else {
                    throw new Error(data.message || data.error || 'Failed to send emails');
                }
            } catch (error) {
                console.error('Send emails error:', error);
                showToast(error.message || 'Failed to send emails. Please try again.', 'error');
                
                // Re-enable button
                const sendBtn = document.querySelector('#machineStep4 .btn-success');
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalTextForError || '‚úâÔ∏è Send Follow-Up Emails';
            }
        }

        function logout() {
            showConfirmationModal({
                title: 'Logout',
                message: 'Are you sure you want to logout?',
                confirmText: 'Logout',
                cancelText: 'Cancel',
                danger: false,
                onConfirm: () => {
                    localStorage.clear();
                    if (isProduction) {
                        window.location.href = 'https://networkfollowup.netlify.app/login.html';
                    } else {
                        window.location.href = 'login.html';
                    }
                },
                onCancel: () => {}
            });
        }

        // Add Customer Modal with Business Card OCR
        function openAddCustomerModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'addCustomerModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>‚ûï Add Customer</h3>
                        <button class="modal-close" onclick="closeModal('addCustomerModal')">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 24px; padding: 16px; background: #F0F9FF; border-radius: 8px; border: 2px dashed #3B82F6;">
                            <div style="text-align: center; margin-bottom: 12px;">
                                <div style="font-size: 48px;">üìá</div>
                                <h4 style="margin: 8px 0; color: #1E293B;">Upload Business Card</h4>
                                <p style="color: #64748B; font-size: 14px; margin-bottom: 12px;">Take a photo or upload an image of a business card</p>
                                <input type="file" id="businessCardInput" accept="image/*" style="display: none;" onchange="uploadBusinessCard(event)">
                                <button class="btn btn-primary" onclick="document.getElementById('businessCardInput').click()">
                                    üì∑ Upload Business Card
                                </button>
                            </div>
                        </div>
                        
                        <div style="border-top: 1px solid #E2E8F0; padding-top: 24px; margin-top: 24px;">
                            <h4 style="margin-bottom: 16px; color: #1E293B;">Or Enter Manually</h4>
                            <form id="addCustomerForm" onsubmit="saveCustomer(event)">
                                <div class="form-group">
                                    <label>Full Name *</label>
                                    <input type="text" id="customerName" required placeholder="John Smith">
                                </div>
                                <div class="form-group">
                                    <label>Email *</label>
                                    <input type="email" id="customerEmail" required placeholder="john@example.com">
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" id="customerPhone" placeholder="+1 234 567 8900">
                                </div>
                                <div class="form-group">
                                    <label>Company</label>
                                    <input type="text" id="customerCompany" placeholder="Company Name">
                                </div>
                                <div class="form-group">
                                    <label>Role/Title</label>
                                    <input type="text" id="customerRole" placeholder="Job Title">
                                </div>
                                <div class="form-group">
                                    <label>Customer Type *</label>
                                    <select id="customerType" required>
                                        <option value="retail">üõçÔ∏è Retail</option>
                                        <option value="wholesale">üíº Wholesale</option>
                                        <option value="advocates">‚≠ê Advocates</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Country Code</label>
                                    <input type="text" id="customerCountry" placeholder="USA" maxlength="3" style="text-transform: uppercase;">
                                </div>
                                <div style="display: flex; gap: 12px; margin-top: 24px;">
                                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save Customer</button>
                                    <button type="button" class="btn btn-secondary" onclick="closeModal('addCustomerModal')" style="flex: 1;">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function uploadBusinessCard(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Show loading state
            const modal = document.getElementById('addCustomerModal');
            const uploadBtn = modal.querySelector('.btn-primary');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="spinner"></span> Extracting data...';

            try {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch(`${API_URL}/uploads/ocr`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Auto-fill form with extracted data
                    const extracted = data.data;
                    if (extracted.name) document.getElementById('customerName').value = extracted.name;
                    if (extracted.email) document.getElementById('customerEmail').value = extracted.email;
                    if (extracted.phone) document.getElementById('customerPhone').value = extracted.phone;
                    if (extracted.company) document.getElementById('customerCompany').value = extracted.company;
                    if (extracted.role) document.getElementById('customerRole').value = extracted.role;

                    showToast('‚úÖ Business card data extracted! Review and save.', 'success');
                } else {
                    throw new Error(data.message || data.error || 'Failed to extract data');
                }
            } catch (error) {
                console.error('Business card OCR error:', error);
                showToast(error.message || 'Failed to extract data from image. Please enter manually.', 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = originalText;
                // Reset file input
                event.target.value = '';
            }
        }

        async function saveCustomer(event) {
            event.preventDefault();

            const customerData = {
                full_name: document.getElementById('customerName').value.trim(),
                email: document.getElementById('customerEmail').value.trim().toLowerCase(),
                customer_type: document.getElementById('customerType').value,
                country_code: document.getElementById('customerCountry').value.trim().toUpperCase() || 'USA'
            };

            if (!customerData.full_name || !customerData.email) {
                showToast('Please fill in required fields', 'error');
                return;
            }

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span> Saving...';

            try {
                const response = await fetch(`${API_URL}/customers`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(customerData)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast('‚úÖ Customer added successfully!', 'success');
                    closeModal('addCustomerModal');
                    
                    // Reload customers list
                    await loadCustomers();
                    
                    // Reset form
                    document.getElementById('addCustomerForm').reset();
                } else {
                    throw new Error(data.message || data.error || 'Failed to save customer');
                }
            } catch (error) {
                console.error('Save customer error:', error);
                showToast(error.message || 'Failed to save customer. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // Customer list management
        let selectedCustomerIds = [];

        function toggleSelectAllCustomers(checkbox) {
            const checkboxes = document.querySelectorAll('.customer-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateSelectedCustomers();
        }

        function updateSelectedCustomers() {
            const checkboxes = document.querySelectorAll('.customer-checkbox:checked');
            selectedCustomerIds = Array.from(checkboxes).map(cb => cb.dataset.customerId);
        }

        // Modify Customer Modal
        async function openModifyCustomerModal(customerId) {
            try {
                const response = await fetch(`${API_URL}/customers/${customerId}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('Failed to load customer');
                }

                const data = await response.json();
                const customer = data.data;

                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'modifyCustomerModal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3>Edit Client</h3>
                            <button class="modal-close" onclick="closeModal('modifyCustomerModal')">√ó</button>
                        </div>
                        <div class="modal-body">
                            <form id="modifyCustomerForm" onsubmit="saveModifiedCustomer(event, '${customerId}')">
                                <div class="form-group">
                                    <label>Full Name *</label>
                                    <input type="text" id="modifyFullName" value="${customer.full_name || ''}" required placeholder="John Smith">
                                </div>
                                <div class="form-group">
                                    <label>Email *</label>
                                    <input type="email" id="modifyEmail" value="${customer.email || ''}" required placeholder="john@email.com">
                                </div>
                                <div class="form-group">
                                    <label>Client Type *</label>
                                    <select id="modifyCustomerType" required>
                                        <option value="retail" ${customer.customer_type === 'retail' ? 'selected' : ''}>Retail</option>
                                        <option value="wholesale" ${customer.customer_type === 'wholesale' ? 'selected' : ''}>Wholesale</option>
                                        <option value="advocates" ${customer.customer_type === 'advocates' ? 'selected' : ''}>Advocates</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Country</label>
                                    <input type="text" id="modifyCountry" value="${customer.country_code || ''}" placeholder="USA, DEU, ITA, etc.">
                                </div>
                                <div class="modal-footer" style="margin-top: 24px;">
                                    <button type="button" class="btn btn-secondary" onclick="closeModal('modifyCustomerModal')">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error opening modify modal:', error);
                showToast('Error loading client', 'error');
            }
        }

        async function saveModifiedCustomer(event, customerId) {
            event.preventDefault();
            try {
                const fullName = document.getElementById('modifyFullName').value;
                const email = document.getElementById('modifyEmail').value;
                const customerType = document.getElementById('modifyCustomerType').value;
                const country = document.getElementById('modifyCountry').value;

                const response = await fetch(`${API_URL}/customers/${customerId}`, {
                    method: 'PUT',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        full_name: fullName,
                        email: email,
                        customer_type: customerType,
                        country_code: country
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast('‚úÖ Client updated successfully!', 'success');
                    closeModal('modifyCustomerModal');
                    await loadCustomers();
                } else {
                    throw new Error(data.message || data.error || 'Failed to update customer');
                }
            } catch (error) {
                console.error('Error saving customer:', error);
                showToast(error.message || 'Error saving changes', 'error');
            }
        }

        // Message Customer Modal
        async function openMessageCustomerModal(customerId) {
            try {
                const response = await fetch(`${API_URL}/customers/${customerId}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('Failed to load customer');
                }

                const data = await response.json();
                const customer = data.data;

                // Get template based on customer type and country
                const languageMap = {
                    'USA': 'en', 'GBR': 'en', 'CAN': 'en', 'AUS': 'en',
                    'ITA': 'it',
                    'DEU': 'de', 'AUT': 'de', 'CHE': 'de',
                    'FRA': 'fr', 'BEL': 'fr',
                    'ESP': 'es', 'MEX': 'es', 'ARG': 'es'
                };
                const language = languageMap[customer.country_code] || 'en';
                const customerType = customer.customer_type || 'retail';

                // Fetch template from API
                let templateSubject = 'Your doTERRA 25% Discount is Waiting!';
                let templateBody = `Hi {{firstname}},

I'm {{your-name}}, your official doTERRA Wellness Advocate...

Best regards,
{{your-name}}`;

                try {
                    const templateResponse = await fetch(`${API_URL}/emails/templates?type=${customerType}&language=${language}`, {
                        headers: getAuthHeaders()
                    });
                    if (templateResponse.ok) {
                        const templateData = await templateResponse.json();
                        if (templateData.success && templateData.data) {
                            templateSubject = templateData.data.subject || templateSubject;
                            templateBody = templateData.data.body || templateBody;
                        }
                    }
                } catch (err) {
                    console.warn('Could not load template, using default');
                }

                // Personalize template
                const firstName = (customer.full_name || '').split(' ')[0];
                const userName = localStorage.getItem('userName') || 'Your Advocate';
                const personalizedSubject = templateSubject
                    .replace(/\{\{firstname\}\}/g, firstName)
                    .replace(/\{\{fullname\}\}/g, customer.full_name || '')
                    .replace(/\{\{your-name\}\}/g, userName);
                const personalizedBody = templateBody
                    .replace(/\{\{firstname\}\}/g, firstName)
                    .replace(/\{\{fullname\}\}/g, customer.full_name || '')
                    .replace(/\{\{email\}\}/g, customer.email || '')
                    .replace(/\{\{country\}\}/g, customer.country_code || '')
                    .replace(/\{\{your-name\}\}/g, userName);

                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'messageCustomerModal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>Send Message</h3>
                            <button class="modal-close" onclick="closeModal('messageCustomerModal')">√ó</button>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 16px; padding: 12px; background: #F0F9FF; border-radius: 8px;">
                                <strong>Recipient:</strong> ${customer.full_name} (${customer.email})
                            </div>
                            <form id="messageCustomerForm" onsubmit="sendCustomerMessage(event, '${customerId}')">
                                <div class="form-group">
                                    <label>Subject *</label>
                                    <input type="text" id="messageSubject" value="${personalizedSubject}" required>
                                </div>
                                <div class="form-group">
                                    <label>Message *</label>
                                    <textarea id="messageBody" rows="10" required style="width: 100%; padding: 12px; border: 1px solid #E2E8F0; border-radius: 8px; font-family: inherit; resize: vertical;">${personalizedBody}</textarea>
                                    <small style="color: #64748B; margin-top: 4px; display: block;">
                                        Available variables: {{firstname}}, {{fullname}}, {{email}}, {{country}}, {{your-name}}
                                    </small>
                                </div>
                                <div class="modal-footer" style="margin-top: 24px;">
                                    <button type="button" class="btn btn-secondary" onclick="closeModal('messageCustomerModal')">Cancel</button>
                                    <button type="submit" class="btn btn-primary">‚úâÔ∏è Send Message</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error opening message modal:', error);
                showToast('Error loading client', 'error');
            }
        }

        async function sendCustomerMessage(event, customerId) {
            event.preventDefault();
            try {
                const subject = document.getElementById('messageSubject').value;
                const body = document.getElementById('messageBody').value;

                const response = await fetch(`${API_URL}/emails/send`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customer_ids: [customerId],
                        template_type: 'retail', // Will be determined from customer
                        subject: subject,
                        body: body
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast('‚úÖ Message sent successfully!', 'success');
                    closeModal('messageCustomerModal');
                    await loadCustomers();
                } else {
                    throw new Error(data.message || data.error || 'Failed to send message');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showToast(error.message || 'Error sending message', 'error');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check auth first
            if (!checkAuth()) {
                console.error('‚ùå Authentication check failed on page load');
                return;
            }

            // Verify token exists
            const token = localStorage.getItem('authToken');
            if (!token) {
                console.error('‚ùå No auth token in localStorage');
                showToast('Authentication failed - Please log in again', 'error');
                setTimeout(() => {
                    if (isProduction) {
                        window.location.href = 'https://networkfollowup.netlify.app/login.html';
                    } else {
                        window.location.href = 'login.html';
                    }
                }, 2000);
                return;
            }

            console.log('‚úÖ Auth token found, loading dashboard...');
            loadDashboard();
            
            // Add ripple effects to all buttons
            document.querySelectorAll('.btn').forEach(btn => {
                addRippleEffect(btn);
            });
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // ESC to close modals
                if (e.key === 'Escape') {
                    const modal = document.querySelector('.modal-overlay');
                    if (modal) {
                        modal.remove();
                    }
                }
            });
        });
    </script>
</body>
</html>
