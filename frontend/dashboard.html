<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NetworkFollowUp - Dashboard</title>
    <meta name="description" content="NetworkFollowUp - AI-Powered Follow-Up Automation for MLM">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üåø</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Manrope', sans-serif;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            min-height: 100vh;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 32px 24px;
            box-shadow: 2px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 48px;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            border-radius: 12px;
            color: #64748B;
            text-decoration: none;
            margin-bottom: 8px;
            transition: all 0.3s;
            cursor: pointer;
            font-weight: 600;
            font-size: 15px;
        }

        .nav-item:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #10B981;
            transform: translateX(4px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .nav-icon {
            font-size: 20px;
        }

        .user-section {
            position: absolute;
            bottom: 32px;
            left: 24px;
            right: 24px;
            padding: 16px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 18px;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-weight: 700;
            color: #1E293B;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-email {
            font-size: 12px;
            color: #64748B;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .logout-btn {
            background: none;
            border: none;
            color: #EF4444;
            cursor: pointer;
            font-size: 18px;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .main-content {
            margin-left: 280px;
            padding: 40px;
            min-height: 100vh;
        }

        .header {
            margin-bottom: 40px;
        }

        .welcome-text {
            font-size: 36px;
            font-weight: 800;
            color: white;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .welcome-subtext {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.9);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 12px;
        }

        .stat-label {
            color: #64748B;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: #1E293B;
            line-height: 1;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 24px;
            font-weight: 800;
            color: #1E293B;
        }

        .card-subtitle {
            font-size: 14px;
            color: #64748B;
            margin-top: 4px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Manrope', sans-serif;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #10B981;
            border: 2px solid #10B981;
        }

        .btn-secondary:hover {
            background: #10B981;
            color: white;
        }

        .btn-success {
            background: #10B981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        .section-content {
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* FOLLOW-UP MACHINE STYLES */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .machine-step {
            animation: fadeIn 0.3s ease;
        }

        .email-preview-card {
            animation: slideIn 0.3s ease;
            transition: all 0.3s ease;
        }

        .email-preview-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12) !important;
            transform: translateY(-2px);
        }

        .extracted-customers-table tbody tr {
            transition: background 0.2s ease;
        }

        .extracted-customers-table tbody tr:hover {
            background: #F8FAFC;
        }

        .spinner {
            border: 3px solid rgba(16, 185, 129, 0.2);
            border-top: 3px solid #10B981;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .type-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .type-badge.type-retail {
            background: #FEF3C7;
            color: #92400E;
        }

        .type-badge.type-wholesale {
            background: #DBEAFE;
            color: #1E40AF;
        }

        .type-badge.type-advocates {
            background: #E9D5FF;
            color: #6B21A8;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #10B981;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Professional button styles */
        .btn-primary {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary {
            background: white;
            color: #64748B;
            border: 2px solid #E2E8F0;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: #F8FAFC;
            border-color: #10B981;
            color: #10B981;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 13px;
        }

        /* Smooth scroll */
        html {
            scroll-behavior: smooth;
        }
        .wizard-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .wizard-steps::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 0;
            right: 0;
            height: 2px;
            background: #E2E8F0;
            z-index: 0;
        }

        .wizard-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            position: relative;
            z-index: 1;
            flex: 1;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: white;
            border: 3px solid #E2E8F0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #94A3B8;
            transition: all 0.3s;
        }

        .wizard-step.active .step-circle {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            border-color: #10B981;
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .wizard-step.completed .step-circle {
            background: #10B981;
            border-color: #10B981;
            color: white;
        }

        .step-label {
            font-size: 13px;
            font-weight: 600;
            color: #94A3B8;
        }

        .wizard-step.active .step-label {
            color: #10B981;
        }

        .upload-zone {
            border: 3px dashed #CBD5E1;
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.03) 0%, rgba(118, 75, 162, 0.03) 100%);
        }

        .upload-zone:hover {
            border-color: #10B981;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
            transform: scale(1.01);
        }

        .upload-zone.dragover {
            border-color: #10B981;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
        }

        .customer-preview {
            background: #F8FAFC;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .customer-checkbox {
            width: 20px;
            height: 20px;
        }

        .customer-info {
            flex: 1;
        }

        .customer-name {
            font-weight: 700;
            color: #1E293B;
            margin-bottom: 4px;
        }

        .customer-details {
            font-size: 13px;
            color: #64748B;
        }

        .type-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .type-retail {
            background: rgba(59, 130, 246, 0.1);
            color: #3B82F6;
        }

        .type-wholesale {
            background: rgba(168, 85, 247, 0.1);
            color: #A855F7;
        }

        .type-advocates {
            background: rgba(245, 158, 11, 0.1);
            color: #F59E0B;
        }

        /* CUSTOMERS TABLE STYLES */
        .filters {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: 2px solid #E2E8F0;
            background: white;
            color: #64748B;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .filter-btn:hover {
            border-color: #10B981;
            color: #10B981;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #10B981 0%, #059669 100%);
            border-color: #10B981;
            color: white;
        }

        .customers-table {
            width: 100%;
            border-collapse: collapse;
        }

        .customers-table th {
            text-align: left;
            padding: 12px;
            background: #F8FAFC;
            color: #64748B;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 2px solid #E2E8F0;
        }

        .customers-table td {
            padding: 16px 12px;
            border-bottom: 1px solid #F1F5F9;
            color: #475569;
        }

        .customers-table tr:hover {
            background: #F8FAFC;
        }

        .email-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .email-status.sent {
            background: rgba(16, 185, 129, 0.1);
            color: #10B981;
        }

        .email-status.pending {
            background: rgba(245, 158, 11, 0.1);
            color: #F59E0B;
        }

        .email-status.not-sent {
            background: rgba(148, 163, 184, 0.1);
            color: #94A3B8;
        }

        .country-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .country-card {
            padding: 16px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-radius: 12px;
            text-align: center;
        }

        .country-flag {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .country-name {
            font-weight: 700;
            color: #1E293B;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .country-count {
            font-size: 24px;
            font-weight: 800;
            color: #10B981;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #334155;
            font-weight: 600;
            font-size: 14px;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #E2E8F0;
            border-radius: 12px;
            font-family: 'Manrope', sans-serif;
            font-size: 14px;
            transition: all 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #10B981;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .customer-type-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .type-option {
            padding: 20px;
            border: 2px solid #E2E8F0;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .type-option:hover {
            border-color: #10B981;
            transform: translateY(-2px);
        }

        .type-option.selected {
            border-color: #10B981;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .type-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .type-title {
            font-weight: 700;
            color: #1E293B;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .type-description {
            font-size: 12px;
            color: #64748B;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748B;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                padding: 24px;
            }
            
            .main-content {
                margin-left: 0;
                padding: 24px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .customer-type-selector {
                grid-template-columns: 1fr;
            }

            .wizard-steps {
                flex-direction: column;
                gap: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo">NFU</div>
        
        <nav>
            <a class="nav-item active" onclick="showSection('dashboard', event)">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </a>
            <a class="nav-item" onclick="showSection('machine', event)">
                <span class="nav-icon">üöÄ</span>
                <span>Follow-Up Machine</span>
            </a>
            <a class="nav-item" onclick="showSection('customers', event)">
                <span class="nav-icon">üë•</span>
                <span>Customers</span>
            </a>
            <a class="nav-item" onclick="showSection('history', event)">
                <span class="nav-icon">üìú</span>
                <span>History</span>
            </a>
            <a class="nav-item" onclick="showSection('billing', event)">
                <span class="nav-icon">üí≥</span>
                <span>Billing</span>
            </a>
            <a class="nav-item" onclick="showSection('templates', event)">
                <span class="nav-icon">üìß</span>
                <span>Email Templates</span>
            </a>
            <a class="nav-item" onclick="showSection('settings', event)">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span>Settings</span>
            </a>
            <!-- Complete Onboarding Button (shown when onboarding incomplete) -->
            <a class="nav-item" id="completeOnboardingBtn" onclick="goToOnboarding()" style="display: none; background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%); color: white;">
                <span class="nav-icon">‚ú®</span>
                <span>Complete Onboarding</span>
            </a>
        </nav>

        <div class="user-section">
            <div class="user-avatar" id="userAvatar">U</div>
            <div class="user-info">
                <div class="user-name" id="userName">Loading...</div>
                <div class="user-email" id="userEmail">Loading...</div>
            </div>
            <button class="logout-btn" onclick="logout()" title="Logout">üö™</button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- DASHBOARD SECTION -->
        <div id="dashboard-section" class="section-content">
            <div class="header">
                <h1 class="welcome-text">Welcome back, <span id="welcomeName">User</span>! üëã</h1>
                <p class="welcome-subtext">Here's your team overview and recent activity</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-label">Total Customers</div>
                    <div class="stat-value" id="totalCustomers">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üìß</div>
                    <div class="stat-label">Emails Sent</div>
                    <div class="stat-value" id="totalEmails">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">‚úì</div>
                    <div class="stat-label">Follow-Ups Done</div>
                    <div class="stat-value" id="followUpsDone">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">‚è∞</div>
                    <div class="stat-label">Pending</div>
                    <div class="stat-value" id="pendingFollowUps">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üõçÔ∏è</div>
                    <div class="stat-label">Retail</div>
                    <div class="stat-value" id="retailCount">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üíº</div>
                    <div class="stat-label">Wholesale</div>
                    <div class="stat-value" id="wholesaleCount">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-label">Advocates</div>
                    <div class="stat-value" id="advocatesCount">0</div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üåç</div>
                    <div class="stat-label">Countries</div>
                    <div class="stat-value" id="countriesCount">0</div>
                </div>
            </div>

            <!-- Charts Section -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 32px;">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Emails Sent (Last 7 Days)</h2>
                    </div>
                    <div style="padding: 20px;">
                        <canvas id="emailsChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Revenue Trend (Last 30 Days)</h2>
                    </div>
                    <div style="padding: 20px;">
                        <canvas id="revenueChart" style="max-height: 300px;"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Quick Start</h2>
                        <p class="card-subtitle">Get started with your follow-ups</p>
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                    <button class="btn btn-primary" onclick="showSection('machine', event)">
                        üöÄ Launch Follow-Up Machine
                    </button>
                    <button class="btn btn-secondary" onclick="showSection('customers', event)">
                        üë• View Customers
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Customers by Country</h2>
                        <p class="card-subtitle">Your team distribution</p>
                    </div>
                </div>
                <div class="country-stats" id="countryStats">
                    <div class="empty-state">
                        <div class="empty-icon">üåç</div>
                        <p>No customers yet. Upload a screenshot to get started!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- FOLLOW-UP MACHINE SECTION -->
        <div id="machine-section" class="section-content" style="display: none;">
            <div class="header">
                <h1 class="welcome-text">Follow-Up Machine üöÄ</h1>
                <p class="welcome-subtext">Upload, extract, and send follow-up emails in minutes</p>
            </div>

            <div class="card">
                <div class="wizard-steps">
                    <div class="wizard-step active" id="step1">
                        <div class="step-circle">1</div>
                        <div class="step-label">Upload</div>
                    </div>
                    <div class="wizard-step" id="step2">
                        <div class="step-circle">2</div>
                        <div class="step-label">Extract</div>
                    </div>
                    <div class="wizard-step" id="step3">
                        <div class="step-circle">3</div>
                        <div class="step-label">Review</div>
                    </div>
                    <div class="wizard-step" id="step4">
                        <div class="step-circle">4</div>
                        <div class="step-label">Send</div>
                    </div>
                </div>

                <!-- Step 1: Upload -->
                <div id="machineStep1" class="machine-step">
                    <h3 style="margin-bottom: 20px; color: #1E293B;">Step 1: Upload Screenshot</h3>
                    <div class="upload-zone" id="machineUploadZone" onclick="document.getElementById('machineFileInput').click()">
                        <div style="font-size: 60px; margin-bottom: 16px;">üì∑</div>
                        <div style="font-size: 18px; font-weight: 600; color: #1E293B; margin-bottom: 8px;">
                            Click or drag to upload screenshot
                        </div>
                        <div style="font-size: 14px; color: #64748B;">
                            PNG, JPG up to 10MB ‚Ä¢ AI will extract customer data
                        </div>
                        <input type="file" id="machineFileInput" accept="image/*" style="display: none;" onchange="handleMachineUpload(event)">
                    </div>
                </div>

                <!-- Step 2: Extract & Display (hidden initially) -->
                <div id="machineStep2" class="machine-step" style="display: none;">
                    <!-- Loading State -->
                    <div id="step2Loading" style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 64px; margin-bottom: 24px; animation: pulse 2s infinite;">ü§ñ</div>
                        <div style="font-size: 20px; font-weight: 600; color: #1E293B; margin-bottom: 12px;">
                            AI is analyzing your screenshot
                        </div>
                        <div style="font-size: 14px; color: #64748B; margin-bottom: 24px;">
                            Extracting customer names, emails, types, and countries...
                        </div>
                        <div class="spinner" style="width: 40px; height: 40px; margin: 0 auto;"></div>
                    </div>

                    <!-- Results State -->
                    <div id="step2Results" style="display: none;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                            <h3 style="margin: 0; color: #1E293B;">
                                ‚úÖ Extracted <span id="extractCount" style="color: #10B981; font-weight: 700;">0</span> Customers
                            </h3>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn btn-sm btn-secondary" onclick="selectAllExtracted()">Select All</button>
                                <button class="btn btn-sm btn-secondary" onclick="deselectAllExtracted()">Deselect All</button>
                            </div>
                        </div>

                        <div class="extracted-customers-table" style="background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: #F8FAFC;">
                                    <tr>
                                        <th style="width: 50px; padding: 16px; text-align: left; font-size: 12px; font-weight: 600; color: #64748B; text-transform: uppercase;">
                                            <input type="checkbox" id="selectAllExtracted" onchange="toggleSelectAllExtracted(this)" style="cursor: pointer;">
                                        </th>
                                        <th style="padding: 16px; text-align: left; font-size: 12px; font-weight: 600; color: #64748B; text-transform: uppercase;">Name</th>
                                        <th style="padding: 16px; text-align: left; font-size: 12px; font-weight: 600; color: #64748B; text-transform: uppercase;">Email</th>
                                        <th style="padding: 16px; text-align: left; font-size: 12px; font-weight: 600; color: #64748B; text-transform: uppercase;">Type</th>
                                        <th style="padding: 16px; text-align: left; font-size: 12px; font-weight: 600; color: #64748B; text-transform: uppercase;">Country</th>
                                        <th style="padding: 16px; text-align: left; font-size: 12px; font-weight: 600; color: #64748B; text-transform: uppercase;">Language</th>
                                        <th style="padding: 16px; text-align: left; font-size: 12px; font-weight: 600; color: #64748B; text-transform: uppercase;">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="extractedCustomersBody" style="font-size: 14px;">
                                    <!-- Populated via JS -->
                                </tbody>
                            </table>
                        </div>

                        <div style="margin-top: 24px; display: flex; justify-content: space-between; align-items: center; padding: 20px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); border-radius: 16px; color: white;">
                            <div>
                                <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">Ready to continue</div>
                                <div style="font-size: 18px; font-weight: 700;">
                                    <span id="selectedCountStep2">0</span> customer<span id="selectedCountPlural">s</span> selected
                                </div>
                            </div>
                            <button id="sendSelectedEmails" class="btn btn-primary" onclick="sendSelectedEmails()" style="background: white; color: #10B981; font-weight: 600; padding: 12px 32px; border: none;">
                                üìß Send Selected Emails
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Review & Preview (hidden initially) -->
                <div id="machineStep3" class="machine-step" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                        <h3 style="margin: 0; color: #1E293B;">üìß Review & Customize Emails</h3>
                        <button class="btn btn-sm btn-secondary" onclick="goBackToStep2()">‚Üê Back</button>
                    </div>

                    <div class="bulk-actions" style="background: white; padding: 20px; border-radius: 16px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                        <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
                            <label style="font-weight: 600; color: #1E293B; font-size: 14px;">Apply template to all:</label>
                            <select id="bulkTemplateSelect" style="flex: 1; min-width: 200px; padding: 10px 16px; border: 2px solid #E2E8F0; border-radius: 8px; font-size: 14px; background: white;">
                                <option value="">Select template...</option>
                                <option value="retail-en">Retail - English</option>
                                <option value="retail-it">Retail - Italian</option>
                                <option value="retail-de">Retail - German</option>
                                <option value="retail-fr">Retail - French</option>
                                <option value="retail-es">Retail - Spanish</option>
                                <option value="wholesale-en">Wholesale - English</option>
                                <option value="wholesale-it">Wholesale - Italian</option>
                                <option value="wholesale-de">Wholesale - German</option>
                                <option value="wholesale-fr">Wholesale - French</option>
                                <option value="wholesale-es">Wholesale - Spanish</option>
                                <option value="advocates-en">Advocates - English</option>
                                <option value="advocates-it">Advocates - Italian</option>
                                <option value="advocates-de">Advocates - German</option>
                                <option value="advocates-fr">Advocates - French</option>
                                <option value="advocates-es">Advocates - Spanish</option>
                            </select>
                            <button id="applyBulkTemplate" class="btn btn-secondary" onclick="applyBulkTemplate()" style="padding: 10px 20px;">
                                Apply to All
                            </button>
                        </div>
                    </div>

                    <div id="emailPreviews" style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Populated via JS -->
                    </div>

                    <div style="margin-top: 32px; display: flex; justify-content: space-between; align-items: center; padding: 24px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); border-radius: 16px; color: white;">
                        <div>
                            <div style="font-size: 14px; opacity: 0.9; margin-bottom: 4px;">Ready to send</div>
                            <div style="font-size: 18px; font-weight: 700;">
                                <span id="approvedCount">0</span> email<span id="approvedCountPlural">s</span> approved
                            </div>
                        </div>
                        <button id="approveAndSend" class="btn btn-primary" onclick="proceedToSend()" style="background: white; color: #10B981; font-weight: 600; padding: 12px 32px; border: none;">
                            Approve & Send ‚Üí
                        </button>
                    </div>
                </div>

                <!-- Step 4: Send Confirmation & Progress (hidden initially) -->
                <div id="machineStep4" class="machine-step" style="display: none;">
                    <!-- Send Summary -->
                    <div id="sendSummary" style="background: white; padding: 32px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 24px;">
                        <h3 style="margin: 0 0 8px 0; color: #1E293B;">üöÄ Ready to Send</h3>
                        <p style="color: #64748B; margin-bottom: 24px;">Review your send details before proceeding</p>
                        
                        <div style="background: #F8FAFC; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                            <div style="font-size: 16px; font-weight: 600; color: #1E293B; margin-bottom: 12px;">
                                You're about to send <strong style="color: #10B981;"><span id="totalEmails">0</span> emails</strong>
                            </div>
                            <ul id="recipientList" style="list-style: none; padding: 0; margin: 0; max-height: 200px; overflow-y: auto;">
                                <!-- Populated via JS -->
                            </ul>
                        </div>

                        <div style="display: flex; gap: 12px;">
                            <button id="sendNowBtn" class="btn btn-primary" onclick="sendEmailsNow()" style="flex: 1; padding: 14px 24px; font-weight: 600;">
                                ‚úâÔ∏è Send Now
                            </button>
                            <button id="scheduleBtn" class="btn btn-secondary" onclick="scheduleEmails()" style="flex: 1; padding: 14px 24px;">
                                ‚è∞ Schedule for Later
                            </button>
                        </div>
                    </div>

                    <!-- Send Progress -->
                    <div id="sendProgress" style="display: none; background: white; padding: 32px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 24px;">
                        <h3 style="margin: 0 0 24px 0; color: #1E293B;">Sending Emails...</h3>
                        
                        <div style="background: #F8FAFC; height: 12px; border-radius: 6px; overflow: hidden; margin-bottom: 16px;">
                            <div id="progressFill" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); height: 100%; width: 0%; transition: width 0.3s ease; border-radius: 6px;"></div>
                        </div>
                        
                        <p style="text-align: center; color: #64748B; font-size: 14px;">
                            Sending <strong style="color: #1E293B;"><span id="currentEmail">1</span></strong> of <strong style="color: #1E293B;"><span id="totalEmailsProgress">10</span></strong>...
                        </p>
                    </div>

                    <!-- Send Success -->
                    <div id="sendSuccess" style="display: none; background: white; padding: 40px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center;">
                        <div style="font-size: 64px; margin-bottom: 16px;">‚úÖ</div>
                        <h3 style="margin: 0 0 8px 0; color: #1E293B;">Success!</h3>
                        <p style="color: #64748B; margin-bottom: 24px; font-size: 16px;">
                            <strong style="color: #10B981; font-size: 20px;"><span id="sentCount">0</span> emails</strong> sent successfully!
                        </p>
                        <div style="display: flex; gap: 12px; justify-content: center;">
                            <button id="viewHistory" class="btn btn-secondary" onclick="showSection('history', event)" style="padding: 12px 24px;">
                                üìú View Email History
                            </button>
                            <button id="sendMore" class="btn btn-primary" onclick="resetMachineFlow()" style="padding: 12px 24px; font-weight: 600;">
                                üöÄ Send More Follow-Ups
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CUSTOMERS SECTION -->
        <div id="customers-section" class="section-content" style="display: none;">
            <div class="header">
                <h1 class="welcome-text">Your Customers üë•</h1>
                <p class="welcome-subtext">Manage your team and track follow-ups</p>
            </div>

            <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-label">Total</div>
                    <div class="stat-value" id="custTotalCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úì</div>
                    <div class="stat-label">Contacted</div>
                    <div class="stat-value" id="custContactedCount">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è∞</div>
                    <div class="stat-label">Pending</div>
                    <div class="stat-value" id="custPendingCount">0</div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">Customer List</h2>
                        <p class="card-subtitle">Filter and manage your customers</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-secondary" onclick="openAddCustomerModal()">
                            ‚ûï Add Customer
                        </button>
                        <button class="btn btn-primary" onclick="showSection('machine', event)">
                            üì§ Upload Screenshot
                        </button>
                    </div>
                </div>

                <div class="filters">
                    <button class="filter-btn active" onclick="filterCustomers('all', event)">All</button>
                    <button class="filter-btn" onclick="filterCustomers('retail', event)">üõçÔ∏è Retail</button>
                    <button class="filter-btn" onclick="filterCustomers('wholesale', event)">üíº Wholesale</button>
                    <button class="filter-btn" onclick="filterCustomers('advocates', event)">‚≠ê Advocates</button>
                    <button class="filter-btn" onclick="filterCustomers('sent', event)">‚úì Email Sent</button>
                    <button class="filter-btn" onclick="filterCustomers('not-sent', event)">‚úó Not Contacted</button>
                </div>

                <div id="customersTableContainer">
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <p style="font-size: 16px; margin-bottom: 16px;">No customers yet</p>
                        <button class="btn btn-primary" onclick="showSection('machine', event)">
                            Upload Screenshot to Get Started
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- HISTORY SECTION -->
        <div id="history-section" class="section-content" style="display: none;">
            <div class="header">
                <h1 class="welcome-text">Email History üìú</h1>
                <p class="welcome-subtext">Track all sent follow-up emails</p>
            </div>

            <div class="card">
                <div class="empty-state">
                    <div class="empty-icon">üì≠</div>
                    <p style="font-size: 16px;">No emails sent yet</p>
                </div>
            </div>
        </div>

        <!-- BILLING SECTION -->
        <div id="billing-section" class="section-content" style="display: none;">
            <div class="header">
                <h1 class="welcome-text">Billing & Subscription üí≥</h1>
                <p class="welcome-subtext">Manage your plan and usage</p>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 16px; color: #1E293B;">Current Plan: <span style="color: #10B981;">Free</span></h3>
                <p style="color: #64748B; margin-bottom: 24px;">10 emails/month ‚Ä¢ 1 screenshot upload/month</p>
                <button class="btn btn-primary" onclick="alert('Upgrade coming soon!')">
                    ‚≠ê Upgrade to Pro - $29/month
                </button>
            </div>
        </div>

        <!-- TEMPLATES SECTION -->
        <div id="templates-section" class="section-content" style="display: none;">
            <div class="header">
                <h1 class="welcome-text">Email Templates üìß</h1>
                <p class="welcome-subtext">Create and manage professional email templates for each customer type and language</p>
            </div>

            <!-- Default Language Selection -->
            <div class="card" style="margin-bottom: 24px; background: linear-gradient(135deg, #F0F9FF 0%, #E0F2FE 100%); border: 2px solid #0EA5E9;">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">üåç Default Language Settings</h2>
                        <p class="card-subtitle">Set your primary language for email templates (used as fallback when specific language templates are missing)</p>
                    </div>
                </div>
                <div style="padding: 24px;">
                    <div class="form-group" style="max-width: 400px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E293B; font-size: 15px;">Default Language:</label>
                        <select id="defaultLanguageSelectTemplates" onchange="updateDefaultLanguageFromTemplates()" style="width: 100%; padding: 14px 16px; border: 2px solid #E2E8F0; border-radius: 10px; font-size: 15px; background: white; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#0EA5E9'" onmouseout="this.style.borderColor='#E2E8F0'">
                            <option value="en">üá∫üá∏ English</option>
                            <option value="it">üáÆüáπ Italian</option>
                            <option value="fr">üá´üá∑ French</option>
                            <option value="es">üá™üá∏ Spanish</option>
                            <option value="de">üá©üá™ German</option>
                            <option value="pl">üáµüá± Polish</option>
                            <option value="bg">üáßüá¨ Bulgarian</option>
                            <option value="hu">üá≠üá∫ Hungarian</option>
                            <option value="cs">üá®üáø Czech</option>
                            <option value="ru">üá∑üá∫ Russian</option>
                            <option value="pt">üáµüáπ Portuguese</option>
                            <option value="nl">üá≥üá± Dutch</option>
                            <option value="sv">üá∏üá™ Swedish</option>
                            <option value="no">üá≥üá¥ Norwegian</option>
                            <option value="da">üá©üá∞ Danish</option>
                            <option value="fi">üá´üáÆ Finnish</option>
                            <option value="ro">üá∑üá¥ Romanian</option>
                            <option value="sk">üá∏üá∞ Slovak</option>
                            <option value="hr">üá≠üá∑ Croatian</option>
                        </select>
                        <small style="color: #64748B; margin-top: 8px; display: block; font-size: 13px;">This language will be used when a template is not available in the customer's preferred language.</small>
                    </div>
                </div>
            </div>

            <!-- Create New Template Card -->
            <div class="card" style="margin-bottom: 24px; border: 2px solid #E2E8F0;">
                <div class="card-header" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; padding: 20px 24px; border-radius: 16px 16px 0 0;">
                    <div style="flex: 1;">
                        <h2 class="card-title" style="color: white; margin: 0; font-size: 22px;">‚ûï Create New Template</h2>
                        <p class="card-subtitle" style="color: rgba(255,255,255,0.9); margin: 4px 0 0 0; font-size: 14px;">Customize professional messages for each customer type and language</p>
                    </div>
                    <button class="btn btn-primary" onclick="openCreateTemplateModal()" style="padding: 12px 24px; background: white; color: #10B981; font-weight: 700; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                        ‚ûï Create Template
                    </button>
                </div>
                <div style="padding: 32px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E293B; font-size: 14px;">Customer Type: *</label>
                            <select id="newTemplateType" style="width: 100%; padding: 12px 16px; border: 2px solid #E2E8F0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#10B981'" onmouseout="this.style.borderColor='#E2E8F0'">
                                <option value="retail">üõçÔ∏è Retail Customer</option>
                                <option value="wholesale">üíº Wholesale Customer</option>
                                <option value="advocate">‚≠ê Advocate/Distributor</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E293B; font-size: 14px;">Language: *</label>
                            <select id="newTemplateLanguage" style="width: 100%; padding: 12px 16px; border: 2px solid #E2E8F0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#10B981'" onmouseout="this.style.borderColor='#E2E8F0'">
                                <option value="en">üá∫üá∏ English</option>
                                <option value="it">üáÆüáπ Italian</option>
                                <option value="fr">üá´üá∑ French</option>
                                <option value="de">üá©üá™ German</option>
                                <option value="es">üá™üá∏ Spanish</option>
                                <option value="pl">üáµüá± Polish</option>
                                <option value="bg">üáßüá¨ Bulgarian</option>
                                <option value="hu">üá≠üá∫ Hungarian</option>
                                <option value="cs">üá®üáø Czech</option>
                                <option value="ru">üá∑üá∫ Russian</option>
                                <option value="pt">üáµüáπ Portuguese</option>
                                <option value="nl">üá≥üá± Dutch</option>
                                <option value="sv">üá∏üá™ Swedish</option>
                                <option value="no">üá≥üá¥ Norwegian</option>
                                <option value="da">üá©üá∞ Danish</option>
                                <option value="fi">üá´üáÆ Finnish</option>
                                <option value="ro">üá∑üá¥ Romanian</option>
                                <option value="sk">üá∏üá∞ Slovak</option>
                                <option value="hr">üá≠üá∑ Croatian</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E293B; font-size: 14px;">Subject Line: *</label>
                        <input type="text" id="newTemplateSubject" placeholder="Hi {{name}}, special offer for you!" style="width: 100%; padding: 12px 16px; border: 2px solid #E2E8F0; border-radius: 8px; font-size: 14px; transition: all 0.3s;" onfocus="this.style.borderColor='#10B981'; this.style.boxShadow='0 0 0 3px rgba(16,185,129,0.1)'" onblur="this.style.borderColor='#E2E8F0'; this.style.boxShadow='none'">
                    </div>
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #1E293B; font-size: 14px;">Email Body: *</label>
                        <textarea id="newTemplateBody" rows="12" placeholder="Hi {{name}},&#10;&#10;As a {{customer_type}} customer, you have access to exclusive benefits...&#10;&#10;Best regards,&#10;{{your_name}}&#10;{{company_name}}" style="width: 100%; padding: 12px 16px; border: 2px solid #E2E8F0; border-radius: 8px; font-size: 14px; resize: vertical; font-family: inherit; transition: all 0.3s;" onfocus="this.style.borderColor='#10B981'; this.style.boxShadow='0 0 0 3px rgba(16,185,129,0.1)'" onblur="this.style.borderColor='#E2E8F0'; this.style.boxShadow='none'"></textarea>
                    </div>
                    <div style="padding: 16px; background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); border-radius: 10px; margin-bottom: 20px; border: 1px solid #90CAF9;">
                        <div style="font-weight: 600; color: #1E293B; margin-bottom: 10px; font-size: 14px;">üìù Available Variables:</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                            <code style="background: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: #10B981; border: 1px solid #D1FAE5;">{{name}}</code>
                            <code style="background: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: #10B981; border: 1px solid #D1FAE5;">{{customer_type}}</code>
                            <code style="background: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: #10B981; border: 1px solid #D1FAE5;">{{country}}</code>
                            <code style="background: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: #10B981; border: 1px solid #D1FAE5;">{{your_name}}</code>
                            <code style="background: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: #10B981; border: 1px solid #D1FAE5;">{{your_email}}</code>
                            <code style="background: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: #10B981; border: 1px solid #D1FAE5;">{{your_phone}}</code>
                            <code style="background: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; color: #10B981; border: 1px solid #D1FAE5;">{{company_name}}</code>
                        </div>
                        <small style="color: #64748B; margin-top: 10px; display: block; font-size: 12px;">These variables will be automatically replaced with actual customer and your information when sending emails.</small>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-primary" onclick="saveNewTemplate()" style="padding: 14px 28px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 15px; cursor: pointer; box-shadow: 0 4px 12px rgba(16,185,129,0.3); transition: all 0.3s;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16,185,129,0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16,185,129,0.3)'">
                            üíæ Save Template
                        </button>
                        <button class="btn btn-secondary" onclick="clearTemplateForm()" style="padding: 14px 28px; background: white; color: #64748B; border: 2px solid #E2E8F0; border-radius: 10px; font-weight: 600; font-size: 15px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.borderColor='#10B981'; this.style.color='#10B981'" onmouseout="this.style.borderColor='#E2E8F0'; this.style.color='#64748B'">
                            üóëÔ∏è Clear
                        </button>
                    </div>
                </div>
            </div>

            <!-- Your Templates Grid -->
            <div class="card" style="border: 2px solid #E2E8F0;">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">üìã Your Templates</h2>
                        <p class="card-subtitle">Manage and edit your existing email templates</p>
                    </div>
                </div>
                <div id="templatesGrid" style="padding: 24px; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 24px;">
                    <!-- Templates will be loaded here -->
                </div>
            </div>
        </div>

        <!-- SETTINGS SECTION -->
        <div id="settings-section" class="section-content" style="display: none;">
            <div class="header">
                <h1 class="welcome-text">Settings ‚öôÔ∏è</h1>
                <p class="welcome-subtext">Configure your preferences and email templates</p>
            </div>

            <!-- Default Language -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">üåç Default Language</h2>
                        <p class="card-subtitle">Set your primary language for email templates</p>
                    </div>
                </div>
                <div class="form-group">
                    <label>Default Language</label>
                    <select id="defaultLanguageSelect" onchange="updateDefaultLanguage()" style="padding: 12px 16px; border: 2px solid #E2E8F0; border-radius: 8px; font-size: 14px; background: white; width: 100%;">
                        <option value="en">English</option>
                        <option value="it">Italian</option>
                        <option value="fr">French</option>
                        <option value="es">Spanish</option>
                        <option value="de">German</option>
                        <option value="pl">Polish</option>
                        <option value="bg">Bulgarian</option>
                        <option value="hu">Hungarian</option>
                        <option value="cs">Czech</option>
                        <option value="sk">Slovak</option>
                        <option value="ro">Romanian</option>
                        <option value="hr">Croatian</option>
                        <option value="sr">Serbian</option>
                        <option value="ru">Russian</option>
                        <option value="uk">Ukrainian</option>
                        <option value="pt">Portuguese</option>
                        <option value="nl">Dutch</option>
                    </select>
                    <small style="color: #64748B; margin-top: 8px; display: block;">This language will be used as fallback when a template is not available in the customer's language.</small>
                </div>
            </div>

            <!-- Email Templates Management -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">üìß Email Templates</h2>
                        <p class="card-subtitle">Create and manage templates for each customer type and language</p>
                    </div>
                    <button class="btn btn-primary" onclick="openCreateTemplateModal()" style="padding: 10px 20px;">
                        ‚ûï Create New Template
                    </button>
                </div>

                <div class="form-group" style="margin-bottom: 24px;">
                    <label>Filter Templates</label>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <select id="filterTemplateType" onchange="filterTemplates()" style="flex: 1; min-width: 150px; padding: 10px 16px; border: 2px solid #E2E8F0; border-radius: 8px; font-size: 14px; background: white;">
                            <option value="">All Types</option>
                            <option value="retail">Retail</option>
                            <option value="wholesale">Wholesale</option>
                            <option value="advocates">Advocates</option>
                        </select>
                        <select id="filterTemplateLang" onchange="filterTemplates()" style="flex: 1; min-width: 150px; padding: 10px 16px; border: 2px solid #E2E8F0; border-radius: 8px; font-size: 14px; background: white;">
                            <option value="">All Languages</option>
                            <option value="en">English</option>
                            <option value="it">Italian</option>
                            <option value="fr">French</option>
                            <option value="es">Spanish</option>
                            <option value="de">German</option>
                            <option value="pl">Polish</option>
                            <option value="bg">Bulgarian</option>
                            <option value="hu">Hungarian</option>
                        </select>
                    </div>
                </div>

                <div id="templatesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
                    <!-- Templates will be loaded here -->
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-icon">üìù</div>
                        <p style="font-size: 16px; margin-bottom: 16px;">No templates yet</p>
                        <button class="btn btn-primary" onclick="openCreateTemplateModal()">
                            Create Your First Template
                        </button>
                    </div>
                </div>
            </div>

            <!-- Gmail Connection -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <h2 class="card-title">‚úâÔ∏è Gmail Connection</h2>
                        <p class="card-subtitle">Connect your Gmail account to send emails</p>
                    </div>
                </div>
                <div style="margin-bottom: 16px;">
                    <span class="email-status not-sent" id="gmailStatus">‚úó Not Connected</span>
                </div>
                <button class="btn btn-primary" id="connectGmailBtn" onclick="connectGmail()">
                    ‚úâÔ∏è Connect Gmail
                </button>
            </div>
        </div>
    </div>

    <!-- Stripe.js -->
    <script src="https://js.stripe.com/v3/"></script>
    
    <style>
        /* Enhanced Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 10000;
            max-width: 400px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .toast.show {
            display: flex;
            transform: translateX(0);
            opacity: 1;
        }

        .toast-icon {
            font-size: 20px;
            font-weight: bold;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
            color: #1E293B;
        }

        .toast-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #94A3B8;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .toast-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #1E293B;
        }

        .toast.error {
            border-left: 4px solid #EF4444;
        }

        .toast.error .toast-icon {
            color: #EF4444;
        }

        .toast.success {
            border-left: 4px solid #10B981;
        }

        .toast.success .toast-icon {
            color: #10B981;
        }

        .toast.info {
            border-left: 4px solid #3B82F6;
        }

        .toast.info .toast-icon {
            color: #3B82F6;
        }

        .toast.warning {
            border-left: 4px solid #F59E0B;
        }

        .toast.warning .toast-icon {
            color: #F59E0B;
        }

        /* Loading Skeletons */
        .skeleton {
            animation: skeleton-loading 1.5s ease-in-out infinite;
        }

        .skeleton-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            margin-bottom: 12px;
        }

        .skeleton-label {
            width: 60%;
            height: 14px;
            border-radius: 4px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            margin-bottom: 8px;
        }

        .skeleton-value {
            width: 40%;
            height: 24px;
            border-radius: 4px;
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }

        /* Success Animation */
        .success-checkmark {
            display: inline-block;
            font-size: 24px;
            animation: checkmark-pop 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes checkmark-pop {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #64748B;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            color: #1E293B;
            margin-bottom: 8px;
        }

        .empty-message {
            font-size: 14px;
            margin-bottom: 24px;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        /* Email Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
        }

        .modal.modal-show {
            display: flex !important;
        }

        .modal-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .modal-content {
            position: relative;
            background: white;
            padding: 24px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            z-index: 10000;
        }

        .modal-content.modal-large {
            max-width: 800px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-control:focus {
            outline: none;
            border-color: #4CAF50;
        }

        .template-status {
            margin: 16px 0;
            padding: 12px;
            background: #f5f5f5;
            border-radius: 6px;
        }

        .badge-success {
            background: #4CAF50;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
        }

        .badge-warning {
            background: #FF9800;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 13px;
        }

        .variables-help {
            margin-top: 12px;
            padding: 12px;
            background: #E3F2FD;
            border-radius: 6px;
        }

        .variables-help code {
            background: white;
            padding: 2px 6px;
            border-radius: 3px;
            margin: 0 4px;
            font-size: 12px;
        }

        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid #eee;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #45a049;
        }

        .btn-secondary {
            background: #2196F3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #0b7dda;
        }

        .btn-cancel {
            background: #f5f5f5;
            color: #333;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .btn-cancel:hover {
            background: #e0e0e0;
        }

        /* Confirmation Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.2s;
        }

        .modal-content.danger .modal-header h3 {
            color: #EF4444;
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #E2E8F0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: #1E293B;
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #94A3B8;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: rgba(0, 0, 0, 0.05);
            color: #1E293B;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-body p {
            color: #64748B;
            font-size: 14px;
            line-height: 1.6;
            margin: 0;
        }

        .modal-footer {
            padding: 24px;
            border-top: 1px solid #E2E8F0;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                transform: translateY(20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Ripple Effect */
        .btn {
            position: relative;
            overflow: hidden;
        }

        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: ripple-animation 0.6s;
            pointer-events: none;
        }

        @keyframes ripple-animation {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }

        /* Smooth Transitions */
        body {
            transition: opacity 0.3s ease;
        }

        .stat-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stat-value {
            transition: all 0.3s ease;
        }

        .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
    </style>

    <div class="toast" id="toast"></div>

    <script>
        // Auto-detect environment: production or development
        const isProduction = window.location.hostname !== 'localhost' && window.location.hostname !== '127.0.0.1';
        const API_URL = isProduction 
            ? 'https://networkfollowup-production.up.railway.app/api'
            : 'http://localhost:5000/api';
        console.log('Environment:', isProduction ? 'PRODUCTION' : 'DEVELOPMENT');
        console.log('API URL:', API_URL);
        
        // Initialize Stripe
        // Note: In production, this should be loaded from environment variable or config
        // For now, using placeholder - replace with actual publishable key from Stripe Dashboard
        const STRIPE_PUBLISHABLE_KEY = 'pk_test_YOUR_STRIPE_PUBLISHABLE_KEY_HERE';
        const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
        
        let extractedData = [];
        let currentFilter = 'all';
        let allCustomers = []; // Store real customers from API

        function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                if (isProduction) {
                    window.location.href = 'https://networkfollowup.netlify.app/login.html';
                } else {
                    window.location.href = 'login.html';
                }
                return false;
            }
            
            // Check onboarding status
            const onboardingCompleted = localStorage.getItem('onboardingCompleted');
            if (onboardingCompleted !== 'true') {
                if (isProduction) {
                    window.location.href = 'https://networkfollowup.netlify.app/onboarding.html';
                } else {
                    window.location.href = 'onboarding.html';
                }
                return false;
            }
            
            return true;
        }

        function showToast(message, type = 'success', duration = 5000) {
            const toast = document.getElementById('toast');
            if (!toast) return;
            
            const icons = {
                success: '‚úì',
                error: '‚úï',
                info: '‚Ñπ',
                warning: '‚ö†'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type] || icons.success}</div>
                <div class="toast-message">${message}</div>
                <button class="toast-close" onclick="this.parentElement.classList.remove('show')">√ó</button>
            `;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        function showConfirmationModal(options = {}) {
            const {
                title = 'Confirm Action',
                message = 'Are you sure you want to proceed?',
                confirmText = 'Confirm',
                cancelText = 'Cancel',
                onConfirm = () => {},
                onCancel = () => {},
                danger = false
            } = options;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content ${danger ? 'danger' : ''}">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <p>${message}</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove(); (${onCancel.toString()})()">${cancelText}</button>
                        <button class="btn ${danger ? 'btn-danger' : 'btn-primary'}" onclick="this.closest('.modal-overlay').remove(); (${onConfirm.toString()})()">${confirmText}</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEsc);
                    onCancel();
                }
            };
            document.addEventListener('keydown', handleEsc);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                    onCancel();
                }
            });
        }

        function showEmptyState(container, options = {}) {
            const {
                icon = 'üì≠',
                title = 'No data yet',
                message = 'Get started by uploading your first screenshot',
                actionText = 'Upload Screenshot',
                onAction = () => {}
            } = options;
            
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">${icon}</div>
                    <h3 class="empty-title">${title}</h3>
                    <p class="empty-message">${message}</p>
                    ${actionText ? `<button class="btn btn-primary" onclick="(${onAction.toString()})()">${actionText}</button>` : ''}
                </div>
            `;
        }

        function showStatsLoading() {
            const statsGrid = document.querySelector('.stats-grid');
            if (!statsGrid) return;
            
            const skeleton = `
                <div class="stat-card skeleton">
                    <div class="skeleton-icon"></div>
                    <div class="skeleton-label"></div>
                    <div class="skeleton-value"></div>
                </div>
            `;
            
            statsGrid.innerHTML = Array(8).fill(skeleton).join('');
        }

        function showSuccessAnimation(element, message = 'Success!') {
            if (!element) return;
            
            const originalContent = element.innerHTML;
            const originalBg = element.style.background;
            
            element.innerHTML = '<span class="success-checkmark">‚úì</span>';
            element.style.background = 'linear-gradient(135deg, #10B981 0%, #059669 100%)';
            element.style.color = 'white';
            element.style.transform = 'scale(1.1)';
            
            setTimeout(() => {
                element.style.transform = 'scale(1)';
                showToast(message, 'success');
            }, 300);
            
            setTimeout(() => {
                element.innerHTML = originalContent;
                element.style.background = originalBg;
                element.style.color = '';
                element.style.transform = '';
            }, 2000);
        }

        function debounce(func, wait = 300) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Add ripple effect to buttons
        function addRippleEffect(button) {
            button.addEventListener('click', function(e) {
                const ripple = document.createElement('span');
                const rect = this.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;
                
                ripple.style.width = ripple.style.height = size + 'px';
                ripple.style.left = x + 'px';
                ripple.style.top = y + 'px';
                ripple.classList.add('ripple');
                
                this.appendChild(ripple);
                
                setTimeout(() => {
                    ripple.remove();
                }, 600);
            });
        }

        function getAuthHeaders() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                console.error('‚ùå No auth token found in localStorage');
                showToast('Authentication failed - Please log in again', 'error');
                // Redirect to login
                setTimeout(() => {
                    if (isProduction) {
                        window.location.href = 'https://networkfollowup.netlify.app/login.html';
                    } else {
                        window.location.href = 'login.html';
                    }
                }, 2000);
                return {
                    'Content-Type': 'application/json'
                };
            }
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            };
        }

        async function connectGmail() {
            try {
                const btn = document.getElementById('connectGmailBtn');
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner"></span> Connecting...';

                // Redirect to OAuth URL (production or development)
                const oauthUrl = isProduction
                    ? 'https://networkfollowup-production.up.railway.app/api/oauth/google'
                    : 'http://localhost:5000/api/oauth/google';
                console.log('Redirecting to:', oauthUrl);
                window.location.href = oauthUrl;
            } catch (error) {
                console.error('Connect Gmail error:', error);
                showToast('Failed to connect Gmail. Please try again.', 'error');
                document.getElementById('connectGmailBtn').disabled = false;
                document.getElementById('connectGmailBtn').innerHTML = '‚úâÔ∏è Connect Gmail';
            }
        }

        async function checkGmailStatus() {
            try {
                const response = await fetch(`${API_URL}/emails/gmail-status`, {
                    headers: getAuthHeaders()
                });

                const data = await response.json();

                if (data.success && data.connected) {
                    document.getElementById('gmailStatus').textContent = `‚úì Connected: ${data.email}`;
                    document.getElementById('gmailStatus').className = 'email-status sent';
                    document.getElementById('connectGmailBtn').textContent = '‚úì Gmail Connected';
                    document.getElementById('connectGmailBtn').disabled = true;
                } else {
                    document.getElementById('gmailStatus').textContent = '‚úó Not Connected';
                    document.getElementById('gmailStatus').className = 'email-status not-sent';
                }
            } catch (error) {
                console.error('Gmail status check error:', error);
            }
        }

        async function loadDashboard() {
            if (!checkAuth()) return;

            const userName = localStorage.getItem('userName') || 'User';
            const userEmail = localStorage.getItem('userEmail') || '';
            
            document.getElementById('userName').textContent = userName;
            document.getElementById('userEmail').textContent = userEmail;
            document.getElementById('welcomeName').textContent = userName.split(' ')[0];
            document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();

            // Check onboarding status and show button if needed
            await checkOnboardingStatus();

            await checkGmailStatus();
            await loadDashboardStats();
            await loadCustomers();
        }

        async function checkOnboardingStatus() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) return;

                const response = await fetch(`${API_URL}/users/onboarding/status`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        const onboardingCompleted = data.data.onboarding_completed;
                        
                        // Update localStorage
                        localStorage.setItem('onboardingCompleted', onboardingCompleted ? 'true' : 'false');
                        
                        // Show/hide "Complete Onboarding" button
                        const completeBtn = document.getElementById('completeOnboardingBtn');
                        if (completeBtn) {
                            if (!onboardingCompleted) {
                                completeBtn.style.display = 'flex';
                            } else {
                                completeBtn.style.display = 'none';
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking onboarding status:', error);
                // Don't block dashboard load if this fails
            }
        }

        function goToOnboarding() {
            // Redirect to onboarding page
            if (isProduction) {
                window.location.href = 'https://networkfollowup.netlify.app/onboarding.html';
            } else {
                window.location.href = 'onboarding.html';
            }
        }

        // Chart instances
        let emailsChart = null;
        let revenueChart = null;

        async function loadDashboardStats() {
            // Show loading skeletons
            showStatsLoading();
            
            try {
                const response = await fetch(`${API_URL}/users/stats`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('Failed to load stats');
                }

                const data = await response.json();

                if (data.success && data.data) {
                    const stats = data.data;
                    const customers = stats.customers || {};
                    const emails = stats.emails || {};

                    // Animate stat updates
                    const animateValue = (element, start, end, duration) => {
                        if (!element) return;
                        const range = end - start;
                        const increment = range / (duration / 16);
                        let current = start;
                        
                        const timer = setInterval(() => {
                            current += increment;
                            if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                                element.textContent = end;
                                clearInterval(timer);
                            } else {
                                element.textContent = Math.floor(current);
                            }
                        }, 16);
                    };

                    // Update dashboard stats with animation
                    const totalCustomers = customers.total || 0;
                    const totalEmails = emails.sent || 0;
                    const pending = customers.pending || 0;
                    const retail = customers.retail || 0;
                    const wholesale = customers.wholesale || 0;
                    const advocates = customers.advocates || 0;
                    const countries = customers.countries || 0;

                    animateValue(document.getElementById('totalCustomers'), 0, totalCustomers, 500);
                    animateValue(document.getElementById('totalEmails'), 0, totalEmails, 500);
                    animateValue(document.getElementById('followUpsDone'), 0, totalEmails, 500);
                    animateValue(document.getElementById('pendingFollowUps'), 0, pending, 500);
                    animateValue(document.getElementById('retailCount'), 0, retail, 500);
                    animateValue(document.getElementById('wholesaleCount'), 0, wholesale, 500);
                    animateValue(document.getElementById('advocatesCount'), 0, advocates, 500);
                    animateValue(document.getElementById('countriesCount'), 0, countries, 500);

                    // Load charts
                    await loadCharts();

                    // Update country stats
                    if (stats.countryBreakdown && stats.countryBreakdown.length > 0) {
                        updateCountryStatsFromAPI(stats.countryBreakdown);
                    } else {
                        const container = document.getElementById('countryStats');
                        showEmptyState(container, {
                            icon: 'üåç',
                            title: 'No customers yet',
                            message: 'Upload a screenshot to extract customer data and see country breakdown',
                            actionText: 'Upload Screenshot',
                            onAction: () => showSection('machine', {target: {closest: () => null}})
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading dashboard stats:', error);
                // Show zeros on error
                document.getElementById('totalCustomers').textContent = '0';
                document.getElementById('totalEmails').textContent = '0';
                document.getElementById('followUpsDone').textContent = '0';
                document.getElementById('pendingFollowUps').textContent = '0';
                showToast('Failed to load dashboard stats', 'error');
            }
        }

        async function loadCharts() {
            try {
                // Get email history for last 7 days
                const emailResponse = await fetch(`${API_URL}/emails/history?limit=100`, {
                    headers: getAuthHeaders()
                });
                const emailData = await emailResponse.json();

                // Process email data for chart
                const last7Days = [];
                const emailCounts = {};
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    last7Days.push(dateStr);
                    emailCounts[dateStr] = 0;
                }

                if (emailData.success && emailData.data) {
                    emailData.data.forEach(email => {
                        if (email.sent_at) {
                            const dateStr = email.sent_at.split('T')[0];
                            if (emailCounts.hasOwnProperty(dateStr)) {
                                emailCounts[dateStr]++;
                            }
                        }
                    });
                }

                // Create emails chart
                const emailsCtx = document.getElementById('emailsChart');
                if (emailsCtx && typeof Chart !== 'undefined') {
                    if (emailsChart) emailsChart.destroy();
                    emailsChart = new Chart(emailsCtx, {
                        type: 'bar',
                        data: {
                            labels: last7Days.map(d => new Date(d).toLocaleDateString('en-US', { weekday: 'short' })),
                            datasets: [{
                                label: 'Emails Sent',
                                data: last7Days.map(d => emailCounts[d]),
                                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                borderColor: 'rgba(16, 185, 129, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }

                // Revenue chart (mock data - replace with real revenue data)
                const revenueCtx = document.getElementById('revenueChart');
                if (revenueCtx && typeof Chart !== 'undefined') {
                    const last30Days = [];
                    const revenueData = [];
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        last30Days.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                        // Mock revenue - replace with real data
                        revenueData.push(Math.random() * 1000 + 500);
                    }

                    if (revenueChart) revenueChart.destroy();
                    revenueChart = new Chart(revenueCtx, {
                        type: 'line',
                        data: {
                            labels: last30Days,
                            datasets: [{
                                label: 'Revenue ($)',
                                data: revenueData,
                                borderColor: 'rgba(16, 185, 129, 1)',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false }
                            },
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading charts:', error);
            }
        }

        function updateCountryStatsFromAPI(countryBreakdown) {
            const flags = { USA: 'üá∫üá∏', DEU: 'üá©üá™', ESP: 'üá™üá∏', ITA: 'üáÆüáπ', FRA: 'üá´üá∑', GBR: 'üá¨üáß', CAN: 'üá®üá¶', AUS: 'üá¶üá∫' };
            const names = { 
                USA: 'USA', DEU: 'Germany', ESP: 'Spain', ITA: 'Italy', FRA: 'France',
                GBR: 'UK', CAN: 'Canada', AUS: 'Australia'
            };

            const html = countryBreakdown.map(item => `
                <div class="country-card">
                    <div class="country-flag">${flags[item.country_code] || 'üåç'}</div>
                    <div class="country-name">${names[item.country_code] || item.country_code}</div>
                    <div class="country-count">${item.count}</div>
                </div>
            `).join('');

            document.getElementById('countryStats').innerHTML = html || '<div class="empty-state"><div class="empty-icon">üåç</div><p>No customers yet</p></div>';
        }

        async function loadCustomers() {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    console.error('‚ùå No auth token - cannot load customers');
                    return;
                }

                const response = await fetch(`${API_URL}/customers`, {
                    headers: getAuthHeaders()
                });

                if (response.status === 401 || response.status === 403) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('‚ùå Authentication failed:', errorData);
                    showToast('Authentication failed - Please log in again', 'error');
                    localStorage.clear();
                    setTimeout(() => {
                        if (isProduction) {
                            window.location.href = 'https://networkfollowup.netlify.app/login.html';
                        } else {
                            window.location.href = 'login.html';
                        }
                    }, 2000);
                    return;
                }

                if (!response.ok) {
                    throw new Error('Failed to load customers');
                }

                const data = await response.json();

                if (data.success && data.data) {
                    // Transform API data to match expected format
                    allCustomers = data.data.map(c => ({
                        id: c.id,
                        name: c.full_name,
                        email: c.email,
                        type: c.member_type || c.customer_type,
                        country: c.country_code,
                        emailSent: c.last_contacted_at !== null || c.email_sent === true
                    }));

                    updateCustomersTable();
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                showToast('Failed to load customers. Please refresh.', 'error');
            }
        }

        // updateDashboardStats removed - now using loadDashboardStats() which loads from API

        function updateCustomersTable() {
            let filtered = allCustomers;
            
            if (currentFilter === 'retail') filtered = filtered.filter(c => c.type === 'retail');
            if (currentFilter === 'wholesale') filtered = filtered.filter(c => c.type === 'wholesale');
            if (currentFilter === 'advocates') filtered = filtered.filter(c => c.type === 'advocates');
            if (currentFilter === 'sent') filtered = filtered.filter(c => c.emailSent);
            if (currentFilter === 'not-sent') filtered = filtered.filter(c => !c.emailSent);

            document.getElementById('custTotalCount').textContent = allCustomers.length;
            document.getElementById('custContactedCount').textContent = allCustomers.filter(c => c.emailSent).length;
            document.getElementById('custPendingCount').textContent = allCustomers.filter(c => !c.emailSent).length;

            if (filtered.length === 0) {
                document.getElementById('customersTableContainer').innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><p>No customers match this filter</p></div>';
                return;
            }

            const html = `
                <table class="customers-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="selectAllCustomers" onchange="toggleSelectAllCustomers(this)"></th>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Type</th>
                            <th>Country</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filtered.map(c => `
                            <tr>
                                <td><input type="checkbox" class="customer-checkbox" data-customer-id="${c.id}" onchange="updateSelectedCustomers()"></td>
                                <td><strong>${c.name}</strong></td>
                                <td>${c.email}</td>
                                <td><span class="type-badge type-${c.type}">${c.type === 'retail' ? 'RETAIL' : c.type === 'wholesale' ? 'WHOLESALE' : 'ADVOCATES'}</span></td>
                                <td>${c.country || 'N/A'}</td>
                                <td>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-sm btn-secondary" onclick="openModifyCustomerModal('${c.id}')" style="padding: 6px 12px; font-size: 13px;">Edit</button>
                                        <button class="btn btn-sm btn-primary" onclick="openMessageCustomerModal('${c.id}')" style="padding: 6px 12px; font-size: 13px;">Message</button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('customersTableContainer').innerHTML = html;
        }

        function filterCustomers(filter, event) {
            try {
                currentFilter = filter;
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                if (event && event.target) {
                    event.target.classList.add('active');
                }
                updateCustomersTable();
            } catch (error) {
                console.error('Error filtering customers:', error);
            }
        }

        function showSection(section, event) {
            try {
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                if (event && event.target) {
                    const navItem = event.target.closest('.nav-item');
                    if (navItem) navItem.classList.add('active');
                } else {
                    // Find nav item by section
                    document.querySelectorAll('.nav-item').forEach(item => {
                        if (item.getAttribute('onclick') && item.getAttribute('onclick').includes(section)) {
                            item.classList.add('active');
                        }
                    });
                }

                document.querySelectorAll('.section-content').forEach(content => content.style.display = 'none');
                const targetSection = document.getElementById(section + '-section');
                if (targetSection) {
                    targetSection.style.display = 'block';
                    
                    // Load data for specific sections
                    if (section === 'settings') {
                        loadUserSettings();
                        loadUserTemplates();
                    } else                         if (section === 'templates') {
                            loadUserTemplates();
                            loadDefaultLanguageForTemplates();
                        } else if (section === 'dashboard') {
                        loadDashboardStats();
                    } else if (section === 'customers') {
                        loadCustomers();
                    }
                } else {
                    console.error('Section not found:', section);
                }
            } catch (error) {
                console.error('Error showing section:', error);
            }
        }

        async function handleMachineUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Show step 2
            document.getElementById('machineStep1').style.display = 'none';
            document.getElementById('machineStep2').style.display = 'block';
            document.getElementById('step1').classList.remove('active');
            document.getElementById('step1').classList.add('completed');
            document.getElementById('step2').classList.add('active');

            try {
                // Upload screenshot to API
                const formData = new FormData();
                formData.append('screenshot', file);

                const response = await fetch(`${API_URL}/uploads/screenshot`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: formData
                });

                // Parse JSON response with error handling
                let data;
                try {
                    const responseText = await response.text();
                    console.log('Backend raw response:', responseText.substring(0, 500));
                    
                    try {
                        data = JSON.parse(responseText);
                        console.log('Backend parsed response:', data);
                    } catch (parseError) {
                        console.error('‚ùå JSON parse error:', parseError);
                        console.error('Response text:', responseText);
                        throw new Error('Invalid JSON response from server. Please try again.');
                    }
                } catch (fetchError) {
                    console.error('‚ùå Response parsing error:', fetchError);
                    throw new Error('Failed to parse server response. Please try again.');
                }

                // Check if error is due to incomplete onboarding
                if (response.status === 403 && (data.requiresOnboarding || data.error === 'Onboarding required')) {
                    console.error('‚ùå Onboarding not completed - blocking upload');
                    
                    // Update localStorage to reflect actual status
                    localStorage.setItem('onboardingCompleted', 'false');
                    
                    // Show the onboarding button if hidden
                    const completeBtn = document.getElementById('completeOnboardingBtn');
                    if (completeBtn) {
                        completeBtn.style.display = 'flex';
                        // Scroll to button or highlight it
                        completeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                    
                    showToast('Please complete onboarding first. Click "Complete Onboarding" in the sidebar.', 'error', 8000);
                    
                    // Reset to step 1
                    document.getElementById('machineStep2').style.display = 'none';
                    document.getElementById('machineStep1').style.display = 'block';
                    document.getElementById('step1').classList.remove('completed');
                    document.getElementById('step1').classList.add('active');
                    document.getElementById('step2').classList.remove('active');
                    return;
                }

                // Handle response
                if (!response.ok) {
                    const errorMsg = data.error || data.message || `Server error: ${response.status}`;
                    console.error('‚ùå Server error:', response.status, errorMsg);
                    throw new Error(errorMsg);
                }

                // Check success flag
                if (!data.success) {
                    const errorMsg = data.error || data.message || 'Extraction failed';
                    console.error('‚ùå Extraction failed:', errorMsg);
                    
                    if (data.customersExtracted === 0) {
                        showToast('No customers found in screenshot. Please ensure the image contains customer data.', 'warning', 5000);
                    } else {
                        showToast(errorMsg, 'error');
                    }
                    
                    // Reset to step 1
                    document.getElementById('machineStep2').style.display = 'none';
                    document.getElementById('machineStep1').style.display = 'block';
                    document.getElementById('step1').classList.remove('completed');
                    document.getElementById('step1').classList.add('active');
                    document.getElementById('step2').classList.remove('active');
                    return;
                }

                // Check if customers were extracted
                if (data.customersExtracted === 0 || !data.customers || data.customers.length === 0) {
                    console.warn('‚ö†Ô∏è No customers in response:', data);
                    showToast('No customers found in screenshot. Please ensure the image contains customer data.', 'warning', 5000);
                    
                    // Reset to step 1
                    document.getElementById('machineStep2').style.display = 'none';
                    document.getElementById('machineStep1').style.display = 'block';
                    document.getElementById('step1').classList.remove('completed');
                    document.getElementById('step1').classList.add('active');
                    document.getElementById('step2').classList.remove('active');
                    return;
                }

                // Use customers from response (prioritize top-level customers array)
                const customers = data.customers || data.data?.customers || [];
                
                console.log('‚úÖ Extraction successful!');
                console.log('   Customers extracted:', data.customersExtracted);
                console.log('   Customers array length:', customers.length);
                console.log('   First customer:', customers[0]);

                    // Convert API response to extractedData format
                    extractedData = customers.map(c => ({
                        id: c.id,
                        name: c.full_name || c.name,
                        email: c.email,
                        type: c.customer_type || c.member_type || 'retail',
                        country: c.country_code || c.country || 'USA',
                        language: c.language || mapCountryToLanguage(c.country_code || c.country || 'USA'),
                        phone: c.phone || null,
                        selected: true,
                        customer_type: c.customer_type || c.member_type || 'retail',
                        country_code: c.country_code || c.country || 'USA',
                        full_name: c.full_name || c.name
                    }));
                    
                    // Also store in extractedCustomersData for modal access
                    extractedCustomersData = extractedData;

                    console.log('‚úÖ Processed customers:', extractedData.length);
                    console.log('   Sample:', extractedData[0]);
                    
                    // Show Step 2 results (extracted customers table)
                    showStep2Results(extractedData);
                
                // Refresh customer list in background (don't redirect)
                loadCustomers().catch(err => console.error('Background customer refresh failed:', err));
                
                showToast(`‚úÖ Extracted ${extractedData.length} customers!`, 'success');
            } catch (error) {
                console.error('Upload error:', error);
                
                // Check if it's an onboarding error
                if (error.message && error.message.includes('onboarding')) {
                    showToast('Please complete onboarding first. Click "Complete Onboarding" in the sidebar.', 'error', 8000);
                    const completeBtn = document.getElementById('completeOnboardingBtn');
                    if (completeBtn) {
                        completeBtn.style.display = 'flex';
                    }
                } else {
                    showToast(error.message || 'Failed to upload screenshot. Please try again.', 'error');
                }
                
                // Reset to step 1
                document.getElementById('machineStep2').style.display = 'none';
                document.getElementById('machineStep1').style.display = 'block';
                document.getElementById('step1').classList.remove('completed');
                document.getElementById('step1').classList.add('active');
                document.getElementById('step2').classList.remove('active');
            }
        }

        // Country to Language mapping
        function mapCountryToLanguage(countryCode) {
            const countryToLanguage = {
                'USA': 'en', 'GBR': 'en', 'CAN': 'en', 'AUS': 'en',
                'DEU': 'de', 'AUT': 'de', 'CHE': 'de',
                'ITA': 'it',
                'ESP': 'es', 'MEX': 'es', 'ARG': 'es',
                'FRA': 'fr', 'BEL': 'fr'
            };
            return countryToLanguage[countryCode?.toUpperCase()] || 'en';
        }

        // Language name mapping
        function getLanguageName(langCode) {
            const langNames = {
                'en': 'English', 'it': 'Italian', 'de': 'German', 'fr': 'French', 'es': 'Spanish'
            };
            return langNames[langCode] || 'English';
        }

        // Show Step 2 results (extracted customers table)
        function showStep2Results(customers) {
            // Hide loading, show results
            document.getElementById('step2Loading').style.display = 'none';
            document.getElementById('step2Results').style.display = 'block';
            
            // Update count
            document.getElementById('extractCount').textContent = customers.length;
            
            // Build table rows
            const tbody = document.getElementById('extractedCustomersBody');
            tbody.innerHTML = customers.map((c, i) => `
                <tr data-customer-id="${c.id}" style="border-bottom: 1px solid #E2E8F0;">
                    <td style="padding: 16px;">
                        <input type="checkbox" class="extracted-customer-checkbox customer-checkbox" checked data-id="${c.id}" data-index="${i}" onchange="updateSelectedCountStep2()" style="cursor: pointer;">
                    </td>
                    <td style="padding: 16px; font-weight: 600; color: #1E293B;">${c.full_name || c.name || 'N/A'}</td>
                    <td style="padding: 16px; color: #64748B;">${c.email || 'N/A'}</td>
                    <td style="padding: 16px;">
                        <span class="badge badge-${c.type}" style="padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; background: ${c.type === 'retail' ? '#FEF3C7' : c.type === 'wholesale' ? '#DBEAFE' : '#E9D5FF'}; color: ${c.type === 'retail' ? '#92400E' : c.type === 'wholesale' ? '#1E40AF' : '#6B21A8'};">
                            ${c.type === 'retail' ? 'RETAIL' : c.type === 'wholesale' ? 'WHOLESALE' : 'ADVOCATES'}
                        </span>
                    </td>
                    <td style="padding: 16px; color: #64748B;">üåç ${c.country || 'N/A'}</td>
                    <td style="padding: 16px; color: #1E293B; font-weight: 600;"><strong>${(c.language || 'en').toUpperCase()}</strong></td>
                    <td style="padding: 16px;">
                        <button class="btn-view-email" onclick="viewEmail('${c.id}')" style="padding: 6px 12px; background: #10B981; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: 600;">
                            üëÅÔ∏è View & Edit
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Update selected count
            updateSelectedCountStep2();
        }

        // Update selected count in Step 2
        function updateSelectedCountStep2() {
            const selected = Array.from(document.querySelectorAll('.extracted-customer-checkbox:checked')).length;
            document.getElementById('selectedCountStep2').textContent = selected;
            document.getElementById('selectedCountPlural').textContent = selected === 1 ? '' : 's';
            document.getElementById('sendSelectedEmails').disabled = selected === 0;
        }

        // Send selected emails directly from Step 2
        async function sendSelectedEmails() {
            try {
                const selectedCheckboxes = Array.from(document.querySelectorAll('.extracted-customer-checkbox:checked'));
                const selectedIndices = selectedCheckboxes.map(cb => parseInt(cb.dataset.index));
                const selectedCustomers = selectedIndices.map(i => extractedCustomersData[i] || extractedData[i]).filter(c => c);
                
                if (selectedCustomers.length === 0) {
                    showToast('Please select at least one customer', 'error');
                    return;
                }

                // Check for missing templates
                const missingTemplates = [];
                for (const customer of selectedCustomers) {
                    const customerType = customer.customer_type || customer.type || 'retail';
                    const language = customer.language || 'en';
                    
                    try {
                        const token = localStorage.getItem('authToken');
                        const checkResponse = await fetch(`${API_URL}/templates/check`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                customerType: customerType,
                                language: language
                            })
                        });
                        
                        const checkData = await checkResponse.json();
                        if (!checkData.has_template) {
                            missingTemplates.push({ customer, type: customerType, lang: language });
                        }
                    } catch (err) {
                        console.error('Error checking template:', err);
                    }
                }

                // Show warning if templates are missing
                if (missingTemplates.length > 0) {
                    const missingTypes = [...new Set(missingTemplates.map(m => `${m.type}-${m.lang}`))];
                    const proceed = confirm(
                        `‚ö†Ô∏è Missing Templates Detected\n\n` +
                        `${missingTemplates.length} customer(s) don't have templates in their language:\n` +
                        `${missingTypes.join(', ')}\n\n` +
                        `Emails will use fallback templates. Continue?`
                    );
                    if (!proceed) return;
                }

                // Confirm send
                const confirmSend = confirm(
                    `üìß Send Emails\n\n` +
                    `You're about to send ${selectedCustomers.length} email(s) to:\n` +
                    `${selectedCustomers.map(c => `‚Ä¢ ${c.name || c.full_name} (${c.email})`).join('\n')}\n\n` +
                    `Continue?`
                );
                if (!confirmSend) return;

                // Disable button and show loading
                const sendBtn = document.getElementById('sendSelectedEmails');
                const originalText = sendBtn.innerHTML;
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<span class="spinner" style="width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; display: inline-block; animation: spin 0.8s linear infinite; margin-right: 8px;"></span> Sending...';

                let successCount = 0;
                let failedCount = 0;
                const errors = [];

                // Send emails one by one
                for (const customer of selectedCustomers) {
                    try {
                        // Get personalized email for this customer
                        const customerType = customer.customer_type || customer.type || 'retail';
                        const language = customer.language || 'en';
                        
                        // Check if we have edited email
                        let subject, body;
                        if (editedEmails[customer.id]) {
                            subject = editedEmails[customer.id].subject;
                            body = editedEmails[customer.id].body;
                        } else {
                            // Fetch template
                            const token = localStorage.getItem('authToken');
                            const previewResponse = await fetch(`${API_URL}/emails/preview`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${token}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    customerType: customerType,
                                    language: language,
                                    customerName: customer.name || customer.full_name,
                                    countryCode: customer.country_code || customer.country || ''
                                })
                            });

                            if (previewResponse.ok) {
                                const previewData = await previewResponse.json();
                                subject = previewData.subject || `Hello ${(customer.name || customer.full_name).split(' ')[0]}!`;
                                body = previewData.body || `Hi ${customer.name || customer.full_name},\n\nThank you for your interest!\n\nBest regards`;
                            } else {
                                // Fallback
                                const firstName = (customer.name || customer.full_name || '').split(' ')[0];
                                subject = `Hello ${firstName}!`;
                                body = `Hi ${customer.name || customer.full_name},\n\nThank you for your interest in doTERRA!\n\nBest regards`;
                            }
                        }

                        // Send email
                        const sendResponse = await fetch(`${API_URL}/emails/send`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                customer_ids: [customer.id],
                                template_type: customerType,
                                subject: subject,
                                body: body
                            })
                        });

                        const sendData = await sendResponse.json();
                        
                        if (sendResponse.ok && sendData.success) {
                            successCount++;
                        } else {
                            failedCount++;
                            errors.push(`${customer.email}: ${sendData.error || sendData.message || 'Failed'}`);
                            console.error(`Failed to send to ${customer.email}:`, sendData);
                        }
                    } catch (error) {
                        failedCount++;
                        errors.push(`${customer.email}: ${error.message}`);
                        console.error(`Error sending to ${customer.email}:`, error);
                    }

                    // Small delay between emails
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                // Show results
                if (failedCount === 0) {
                    showToast(`‚úÖ Successfully sent ${successCount} email(s)!`, 'success');
                } else {
                    showToast(`${successCount} sent, ${failedCount} failed. Check console for details.`, 'warning');
                    console.error('Send errors:', errors);
                }

                // Refresh customer list
                if (typeof loadCustomers === 'function') {
                    await loadCustomers();
                }

                // Reset button
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalText;

            } catch (error) {
                console.error('Send selected emails error:', error);
                showToast(error.message || 'Failed to send emails. Please try again.', 'error');
                
                // Reset button
                const sendBtn = document.getElementById('sendSelectedEmails');
                if (sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = 'üìß Send Selected Emails';
                }
            }
        }

        // Select/Deselect all in Step 2
        function selectAllExtracted() {
            document.querySelectorAll('.extracted-customer-checkbox').forEach(cb => cb.checked = true);
            updateSelectedCountStep2();
        }

        function deselectAllExtracted() {
            document.querySelectorAll('.extracted-customer-checkbox').forEach(cb => cb.checked = false);
            updateSelectedCountStep2();
        }

        function toggleSelectAllExtracted(checkbox) {
            const allChecked = checkbox.checked;
            document.querySelectorAll('.extracted-customer-checkbox').forEach(cb => cb.checked = allChecked);
            updateSelectedCountStep2();
        }

        // Proceed to Step 3 (Review & Preview)
        async function proceedToReview() {
            const selectedCheckboxes = Array.from(document.querySelectorAll('.extracted-customer-checkbox:checked'));
            const selectedIndices = selectedCheckboxes.map(cb => parseInt(cb.dataset.index));
            const selectedCustomers = selectedIndices.map(i => extractedData[i]).filter(c => c);
            
            if (selectedCustomers.length === 0) {
                showToast('Please select at least one customer', 'error');
                return;
            }
            
            // Update extractedData to only include selected customers
            extractedData = selectedCustomers.map(c => ({ ...c, selected: true }));
            
            // Hide Step 2, show Step 3
            document.getElementById('machineStep2').style.display = 'none';
            document.getElementById('machineStep3').style.display = 'block';
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step2').classList.add('completed');
            document.getElementById('step3').classList.add('active');
            
            // Load email previews for each customer
            await loadEmailPreviews(extractedData);
        }

        // Load email previews with templates
        async function loadEmailPreviews(customers) {
            const container = document.getElementById('emailPreviews');
            container.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="spinner" style="width: 40px; height: 40px; margin: 0 auto;"></div><p style="color: #64748B; margin-top: 16px;">Loading email templates...</p></div>';
            
            const previews = [];
            
            for (const customer of customers) {
                try {
                    // Fetch template for this customer
                    const templateKey = `${customer.type}-${customer.language}`;
                    const template = await fetchEmailTemplate(customer.type, customer.language);
                    
                    // Personalize template
                    const firstName = customer.name.split(' ')[0];
                    const personalizedSubject = (template?.subject || 'Follow-up from doTERRA').replace(/\{\{firstname\}\}/g, firstName).replace(/\{\{fullname\}\}/g, customer.name);
                    const personalizedBody = (template?.body || 'Hello!').replace(/\{\{firstname\}\}/g, firstName).replace(/\{\{fullname\}\}/g, customer.name).replace(/\{\{country\}\}/g, customer.country || '');
                    
                    previews.push({
                        customer,
                        template,
                        subject: personalizedSubject,
                        body: personalizedBody,
                        templateKey
                    });
                } catch (err) {
                    console.error(`Error loading template for ${customer.email}:`, err);
                    // Use default template
                    previews.push({
                        customer,
                        template: null,
                        subject: `Hello ${customer.name.split(' ')[0]}!`,
                        body: `Hi ${customer.name},\n\nThank you for your interest in doTERRA!\n\nBest regards`,
                        templateKey: `${customer.type}-${customer.language}`
                    });
                }
            }
            
            // Render preview cards
            container.innerHTML = previews.map((preview, i) => {
                const c = preview.customer;
                const flagEmoji = {
                    'USA': 'üá∫üá∏', 'GBR': 'üá¨üáß', 'CAN': 'üá®üá¶', 'AUS': 'üá¶üá∫',
                    'DEU': 'üá©üá™', 'AUT': 'üá¶üáπ', 'CHE': 'üá®üá≠',
                    'ITA': 'üáÆüáπ', 'ESP': 'üá™üá∏', 'MEX': 'üá≤üáΩ', 'ARG': 'üá¶üá∑',
                    'FRA': 'üá´üá∑', 'BEL': 'üáßüá™'
                }[c.country] || 'üåç';
                
                return `
                    <div class="email-preview-card" style="background: white; padding: 24px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);" data-customer-index="${i}">
                        <div class="customer-info" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 2px solid #E2E8F0;">
                            <div>
                                <div style="font-weight: 700; font-size: 16px; color: #1E293B; margin-bottom: 4px;">${c.name}</div>
                                <div style="font-size: 14px; color: #64748B;">${c.email}</div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <span class="type-badge type-${c.type}" style="padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                                    ${c.type === 'retail' ? 'RETAIL' : c.type === 'wholesale' ? 'WHOLESALE' : 'ADVOCATES'}
                                </span>
                                <span style="font-size: 20px;">${flagEmoji}</span>
                                <span style="font-size: 12px; color: #64748B;">${getLanguageName(c.language)}</span>
                            </div>
                        </div>
                        
                        <div class="email-preview">
                            <div class="email-subject" style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 600; color: #1E293B; margin-bottom: 8px; font-size: 14px;">Subject:</label>
                                <input type="text" class="email-subject-input" value="${escapeHtml(preview.subject)}" data-customer-index="${i}" style="width: 100%; padding: 12px; border: 2px solid #E2E8F0; border-radius: 8px; font-size: 14px; font-family: inherit;">
                            </div>
                            
                            <div class="email-body" style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 600; color: #1E293B; margin-bottom: 8px; font-size: 14px;">Message:</label>
                                <textarea class="email-body-input" rows="8" data-customer-index="${i}" style="width: 100%; padding: 12px; border: 2px solid #E2E8F0; border-radius: 8px; font-size: 14px; font-family: inherit; resize: vertical;">${escapeHtml(preview.body)}</textarea>
                            </div>
                            
                            <div class="template-selector" style="display: flex; gap: 12px; align-items: center;">
                                <select class="template-select" data-customer-index="${i}" onchange="changeTemplate(${i}, this.value)" style="flex: 1; padding: 10px 16px; border: 2px solid #E2E8F0; border-radius: 8px; font-size: 14px; background: white;">
                                    <option value="retail-en" ${preview.templateKey === 'retail-en' ? 'selected' : ''}>Retail - English</option>
                                    <option value="retail-it" ${preview.templateKey === 'retail-it' ? 'selected' : ''}>Retail - Italian</option>
                                    <option value="retail-de" ${preview.templateKey === 'retail-de' ? 'selected' : ''}>Retail - German</option>
                                    <option value="retail-fr" ${preview.templateKey === 'retail-fr' ? 'selected' : ''}>Retail - French</option>
                                    <option value="retail-es" ${preview.templateKey === 'retail-es' ? 'selected' : ''}>Retail - Spanish</option>
                                    <option value="wholesale-en" ${preview.templateKey === 'wholesale-en' ? 'selected' : ''}>Wholesale - English</option>
                                    <option value="wholesale-it" ${preview.templateKey === 'wholesale-it' ? 'selected' : ''}>Wholesale - Italian</option>
                                    <option value="wholesale-de" ${preview.templateKey === 'wholesale-de' ? 'selected' : ''}>Wholesale - German</option>
                                    <option value="wholesale-fr" ${preview.templateKey === 'wholesale-fr' ? 'selected' : ''}>Wholesale - French</option>
                                    <option value="wholesale-es" ${preview.templateKey === 'wholesale-es' ? 'selected' : ''}>Wholesale - Spanish</option>
                                    <option value="advocates-en" ${preview.templateKey === 'advocates-en' ? 'selected' : ''}>Advocates - English</option>
                                    <option value="advocates-it" ${preview.templateKey === 'advocates-it' ? 'selected' : ''}>Advocates - Italian</option>
                                    <option value="advocates-de" ${preview.templateKey === 'advocates-de' ? 'selected' : ''}>Advocates - German</option>
                                    <option value="advocates-fr" ${preview.templateKey === 'advocates-fr' ? 'selected' : ''}>Advocates - French</option>
                                    <option value="advocates-es" ${preview.templateKey === 'advocates-es' ? 'selected' : ''}>Advocates - Spanish</option>
                                </select>
                                <button class="btn btn-sm btn-secondary" onclick="reloadTemplate(${i})" style="padding: 10px 16px;">
                                    Reload Template
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            updateApprovedCount();
        }

        // Fetch email template from API
        async function fetchEmailTemplate(type, language) {
            try {
                const response = await fetch(`${API_URL}/emails/templates?type=${type}&language=${language}`, {
                    headers: getAuthHeaders()
                });
                
                if (response.ok) {
                    const data = await response.json();
                    return data.data || null;
                }
            } catch (err) {
                console.error('Error fetching template:', err);
            }
            return null;
        }

        // Escape HTML for safe rendering
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Change template for a customer
        async function changeTemplate(customerIndex, templateKey) {
            const [type, lang] = templateKey.split('-');
            const customer = extractedData[customerIndex];
            
            const template = await fetchEmailTemplate(type, lang);
            if (template) {
                const firstName = customer.name.split(' ')[0];
                const subject = template.subject.replace(/\{\{firstname\}\}/g, firstName).replace(/\{\{fullname\}\}/g, customer.name);
                const body = template.body.replace(/\{\{firstname\}\}/g, firstName).replace(/\{\{fullname\}\}/g, customer.name).replace(/\{\{country\}\}/g, customer.country || '');
                
                document.querySelector(`.email-subject-input[data-customer-index="${customerIndex}"]`).value = subject;
                document.querySelector(`.email-body-input[data-customer-index="${customerIndex}"]`).value = body;
            }
        }

        // Reload template
        async function reloadTemplate(customerIndex) {
            const select = document.querySelector(`.template-select[data-customer-index="${customerIndex}"]`);
            await changeTemplate(customerIndex, select.value);
            showToast('Template reloaded', 'success');
        }

        // Apply bulk template to all
        async function applyBulkTemplate() {
            const templateKey = document.getElementById('bulkTemplateSelect').value;
            if (!templateKey) {
                showToast('Please select a template', 'error');
                return;
            }
            
            const [type, lang] = templateKey.split('-');
            
            for (let i = 0; i < extractedData.length; i++) {
                await changeTemplate(i, templateKey);
                document.querySelector(`.template-select[data-customer-index="${i}"]`).value = templateKey;
            }
            
            showToast(`Applied template to all ${extractedData.length} customers`, 'success');
        }

        // Update approved count
        function updateApprovedCount() {
            const count = extractedData.length;
            document.getElementById('approvedCount').textContent = count;
            document.getElementById('approvedCountPlural').textContent = count === 1 ? '' : 's';
        }

        // Go back to Step 2
        function goBackToStep2() {
            document.getElementById('machineStep3').style.display = 'none';
            document.getElementById('machineStep2').style.display = 'block';
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step2').classList.remove('completed');
            document.getElementById('step2').classList.add('active');
        }

        // Proceed to Step 4 (Send Confirmation)
        function proceedToSend() {
            // Collect all email data
            emailData = extractedData.map((customer, i) => {
                const subjectInput = document.querySelector(`.email-subject-input[data-customer-index="${i}"]`);
                const bodyInput = document.querySelector(`.email-body-input[data-customer-index="${i}"]`);
                return {
                    customerId: customer.id,
                    customer: customer,
                    subject: subjectInput ? subjectInput.value : '',
                    body: bodyInput ? bodyInput.value : ''
                };
            }).filter(e => e.subject && e.body);
            
            if (emailData.length === 0) {
                showToast('Please ensure all emails have subject and body', 'error');
                return;
            }
            
            // Hide Step 3, show Step 4
            document.getElementById('machineStep3').style.display = 'none';
            document.getElementById('machineStep4').style.display = 'block';
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step3').classList.add('completed');
            document.getElementById('step4').classList.add('active');
            
            // Show send summary
            document.getElementById('sendSummary').style.display = 'block';
            document.getElementById('sendProgress').style.display = 'none';
            document.getElementById('sendSuccess').style.display = 'none';
            
            // Update summary
            document.getElementById('totalEmails').textContent = emailData.length;
            document.getElementById('totalEmailsProgress').textContent = emailData.length;
            
            const recipientList = document.getElementById('recipientList');
            recipientList.innerHTML = emailData.map(e => `
                <li style="padding: 8px 0; border-bottom: 1px solid #E2E8F0; display: flex; justify-content: space-between;">
                    <span style="color: #1E293B;">${e.customer.name}</span>
                    <span style="color: #64748B; font-size: 12px;">${e.customer.email}</span>
                </li>
            `).join('');
        }

        // Send emails now
        async function sendEmailsNow() {
            if (!emailData || emailData.length === 0) {
                showToast('No emails to send', 'error');
                return;
            }
            
            // Hide summary, show progress
            document.getElementById('sendSummary').style.display = 'none';
            document.getElementById('sendProgress').style.display = 'block';
            document.getElementById('sendSuccess').style.display = 'none';
            
            let sentCount = 0;
            let failedCount = 0;
            
            for (let i = 0; i < emailData.length; i++) {
                const email = emailData[i];
                
                // Update progress
                document.getElementById('currentEmail').textContent = i + 1;
                const progress = ((i + 1) / emailData.length) * 100;
                document.getElementById('progressFill').style.width = progress + '%';
                
                try {
                    const response = await fetch(`${API_URL}/emails/send`, {
                        method: 'POST',
                        headers: {
                            ...getAuthHeaders(),
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            customerId: email.customerId,
                            subject: email.subject,
                            body: email.body
                        })
                    });
                    
                    if (response.ok) {
                        sentCount++;
                    } else {
                        failedCount++;
                        console.error(`Failed to send to ${email.customer.email}`);
                    }
                } catch (err) {
                    failedCount++;
                    console.error(`Error sending to ${email.customer.email}:`, err);
                }
                
                // Small delay to show progress
                await new Promise(resolve => setTimeout(resolve, 300));
            }
            
            // Show success
            document.getElementById('sendProgress').style.display = 'none';
            document.getElementById('sendSuccess').style.display = 'block';
            document.getElementById('sentCount').textContent = sentCount;
            
            if (failedCount > 0) {
                showToast(`${sentCount} sent, ${failedCount} failed`, 'warning');
            } else {
                showToast(`‚úÖ ${sentCount} emails sent successfully!`, 'success');
            }
            
            // Refresh customer list
            await loadCustomers();
        }

        // Schedule emails (placeholder)
        function scheduleEmails() {
            showToast('Scheduling feature coming soon!', 'info');
        }

        // Reset machine flow
        function resetMachineFlow() {
            extractedData = [];
            emailData = [];
            
            // Reset to Step 1
            document.getElementById('machineStep1').style.display = 'block';
            document.getElementById('machineStep2').style.display = 'none';
            document.getElementById('machineStep3').style.display = 'none';
            document.getElementById('machineStep4').style.display = 'none';
            
            // Reset wizard steps
            document.querySelectorAll('.wizard-step').forEach((step, i) => {
                step.classList.remove('active', 'completed');
                if (i === 0) step.classList.add('active');
            });
            
            // Reset file input
            document.getElementById('machineFileInput').value = '';
        }

        // Initialize emailData variable
        let emailData = [];
        
        // Email preview modal variables
        let currentEditingCustomer = null;
        let extractedCustomersData = [];
        let editedEmails = {};

        // View email preview for a customer
        async function viewEmail(customerId) {
            console.log('üîµ Opening email editor for customer:', customerId);
            
            // Find customer in extractedCustomersData
            let customer = extractedCustomersData.find(c => c.id === customerId);
            
            // Fallback to extractedData if not found
            if (!customer) {
                customer = extractedData.find(c => c.id === customerId);
            }
            
            if (!customer) {
                console.error('‚ùå Customer not found:', customerId);
                showToast('Customer not found', 'error');
                return;
            }
            
            currentEditingCustomer = customer;
            console.log('‚úÖ Customer found:', customer);
            
            // Populate modal fields
            document.getElementById('modalCustomerName').value = customer.name || customer.full_name || '';
            document.getElementById('modalCustomerEmail').value = customer.email || '';
            document.getElementById('modalCustomerType').value = (customer.type || customer.customer_type || 'retail').toLowerCase();
            document.getElementById('modalCustomerLanguage').value = (customer.language || 'en').toUpperCase();
            
            // Check if we have edited version
            if (editedEmails[customerId]) {
                document.getElementById('emailSubject').value = editedEmails[customerId].subject;
                document.getElementById('emailBody').value = editedEmails[customerId].body;
                document.getElementById('templateStatusBadge').innerHTML = '<span style="background: #FEF3C7; color: #92400E; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">‚úèÔ∏è Edited</span>';
            } else {
                // Generate from template
                await loadEmailTemplate(customer);
            }
            
            // Show modal
            const modal = document.getElementById('emailModal');
            if (modal) {
                modal.style.display = 'flex';
                modal.style.position = 'fixed';
                modal.style.zIndex = '9999';
                modal.style.left = '0';
                modal.style.top = '0';
                modal.style.width = '100%';
                modal.style.height = '100%';
                modal.style.background = 'rgba(0,0,0,0.5)';
                modal.style.alignItems = 'center';
                modal.style.justifyContent = 'center';
                console.log('‚úÖ Modal displayed');
            } else {
                console.error('‚ùå Email modal not found!');
                showToast('Email modal not found. Please refresh the page.', 'error');
            }
        }
        
        // Load email template for customer
        async function loadEmailTemplate(customer) {
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    showToast('Please log in', 'error');
                    return;
                }

                console.log('üîµ Loading template for:', customer);

                const response = await fetch(`${API_URL}/emails/preview`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customerType: customer.customer_type || customer.type || 'retail',
                        language: customer.language || 'en',
                        customerName: customer.name || customer.full_name,
                        countryCode: customer.country_code || customer.country || ''
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Preview API error:', errorText);
                    throw new Error('Failed to fetch preview');
                }
                
                const data = await response.json();
                console.log('‚úÖ Preview API response:', data);
                
                if (data.success) {
                    document.getElementById('emailSubject').value = data.subject || '';
                    document.getElementById('emailBody').value = data.body || '';
                    
                    // Show template status
                    const statusBadge = document.getElementById('templateStatusBadge');
                    if (data.is_fallback) {
                        statusBadge.innerHTML = `
                            <span style="background: #FEF3C7; color: #92400E; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; margin-right: 8px;">‚ö†Ô∏è Fallback: ${data.template_language.toUpperCase()}</span>
                            <button class="btn-link" onclick="createMissingTemplate('${customer.language || 'en'}', '${customer.customer_type || customer.type || 'retail'}')" style="background: none; border: none; color: #2196F3; cursor: pointer; text-decoration: underline; font-size: 12px;">
                                Create ${(customer.language || 'en').toUpperCase()} template
                            </button>
                        `;
                    } else {
                        statusBadge.innerHTML = `
                            <span style="background: #D1FAE5; color: #065F46; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600;">‚úì Template: ${(customer.customer_type || customer.type || 'retail')}-${(customer.language || 'en').toUpperCase()}</span>
                        `;
                    }
                } else {
                    // Fallback if no template
                    const firstName = (customer.name || customer.full_name || '').split(' ')[0];
                    document.getElementById('emailSubject').value = `Hello ${firstName}!`;
                    document.getElementById('emailBody').value = `Hi ${customer.name || customer.full_name},\n\nThank you for your interest in doTERRA!\n\nBest regards`;
                    document.getElementById('templateStatusBadge').innerHTML = `
                        <span style="background: #FEF3C7; color: #92400E; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; margin-right: 8px;">‚ö†Ô∏è No template found - using default</span>
                        <button class="btn-link" onclick="createMissingTemplate('${customer.language || 'en'}', '${customer.customer_type || customer.type || 'retail'}')" style="background: none; border: none; color: #2196F3; cursor: pointer; text-decoration: underline; font-size: 12px;">
                            Create template
                        </button>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Error loading template:', error);
                showToast('Failed to load email template', 'error');
                // Fallback
                const firstName = (customer.name || customer.full_name || '').split(' ')[0];
                document.getElementById('emailSubject').value = `Hello ${firstName}!`;
                document.getElementById('emailBody').value = `Hi ${customer.name || customer.full_name},\n\nThank you for your interest in doTERRA!\n\nBest regards`;
            }
        }
        
        function createMissingTemplate(language, customerType) {
            closeEmailModal();
            window.location.href = `templates.html?lang=${language}&type=${customerType}`;
        }


        // Save edited email
        function saveEmailChanges() {
            if (!currentEditingCustomer) {
                showToast('No customer selected', 'error');
                return;
            }
            
            const subject = document.getElementById('emailSubject').value.trim();
            const body = document.getElementById('emailBody').value.trim();
            const name = document.getElementById('modalCustomerName').value.trim();
            const email = document.getElementById('modalCustomerEmail').value.trim();
            const type = document.getElementById('modalCustomerType').value;
            const language = document.getElementById('modalCustomerLanguage').value;
            
            if (!subject || !body) {
                showToast('Subject and body are required', 'error');
                return;
            }
            
            // Update customer data
            currentEditingCustomer.name = name;
            currentEditingCustomer.full_name = name;
            currentEditingCustomer.email = email;
            currentEditingCustomer.customer_type = type;
            currentEditingCustomer.type = type;
            currentEditingCustomer.language = language;
            
            // Save custom email
            editedEmails[currentEditingCustomer.id] = { subject, body };
            
            showToast(`‚úÖ Changes saved for ${name}`, 'success');
            closeEmailModal();
            
            // Update table row if visible
            updateCustomerRow(currentEditingCustomer);
        }
        
        function updateCustomerRow(customer) {
            const row = document.querySelector(`tr[data-customer-id="${customer.id}"]`);
            if (row) {
                row.querySelector('td:nth-child(2)').textContent = customer.name || customer.full_name;
                row.querySelector('td:nth-child(3)').textContent = customer.email;
                row.querySelector('td:nth-child(4)').innerHTML = `
                    <span class="badge badge-${customer.type || customer.customer_type}" style="padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; background: ${(customer.type || customer.customer_type) === 'retail' ? '#FEF3C7' : (customer.type || customer.customer_type) === 'wholesale' ? '#DBEAFE' : '#E9D5FF'}; color: ${(customer.type || customer.customer_type) === 'retail' ? '#92400E' : (customer.type || customer.customer_type) === 'wholesale' ? '#1E40AF' : '#6B21A8'};">
                        ${(customer.type || customer.customer_type) === 'retail' ? 'RETAIL' : (customer.type || customer.customer_type) === 'wholesale' ? 'WHOLESALE' : 'ADVOCATES'}
                    </span>
                `;
                row.querySelector('td:nth-child(6)').innerHTML = `<strong>${(customer.language || 'en').toUpperCase()}</strong>`;
            }
        }

        // Reset to template
        async function resetToTemplate() {
            if (!currentEditingCustomer) return;
            
            delete editedEmails[currentEditingCustomer.id];
            await loadEmailTemplate(currentEditingCustomer);
            showToast('Email reset to template', 'info');
        }

        // Close email modal
        function closeEmailModal() {
            const modal = document.getElementById('emailModal');
            if (modal) {
                modal.classList.remove('modal-show');
                modal.style.display = 'none';
            }
            currentEditingCustomer = null;
        }

        // Send email directly from modal
        async function sendEmailFromModal() {
            if (!currentEditingCustomer) {
                showToast('No customer selected', 'error');
                return;
            }

            const subject = document.getElementById('emailSubject').value.trim();
            const body = document.getElementById('emailBody').value.trim();
            const email = document.getElementById('modalCustomerEmail').value.trim();

            if (!subject || !body) {
                showToast('Subject and body are required', 'error');
                return;
            }
            
            if (!email) {
                showToast('Customer email is required', 'error');
                return;
            }

            // Disable button and show loading
            const sendBtn = event?.target || document.querySelector('#emailModal .btn-primary');
            const originalText = sendBtn.innerHTML;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="spinner" style="width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; display: inline-block; animation: spin 0.8s linear infinite;"></span> Sending...';

            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('Not authenticated');
                }

                const response = await fetch(`${API_URL}/emails/send`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customer_ids: [currentEditingCustomer.id],
                        template_type: currentEditingCustomer.customer_type || currentEditingCustomer.type || 'retail',
                        subject: subject,
                        body: body
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast(`‚úÖ Email sent to ${currentEditingCustomer.name || currentEditingCustomer.full_name}!`, 'success');
                    closeEmailModal();
                    
                    // Refresh customer list to update "sent" status
                    if (typeof loadCustomers === 'function') {
                        await loadCustomers();
                    }
                } else {
                    throw new Error(data.error || data.message || 'Failed to send email');
                }
            } catch (error) {
                console.error('Send email error:', error);
                showToast(error.message || 'Failed to send email. Please try again.', 'error');
            } finally {
                if (sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = originalText;
                }
            }
        }

        // Load user templates for settings
        async function loadUserTemplates() {
            try {
                const response = await fetch(`${API_URL}/templates`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('Failed to load templates');
                }

                const data = await response.json();
                console.log('Templates response:', data);
                
                // Handle both response formats: {success: true, data: [...]} or {templates: [...]}
                const templates = (data.success && data.data) ? data.data : (data.templates || []);
                
                const grid = document.getElementById('templatesGrid');
                if (!grid) {
                    console.error('Templates grid not found');
                    return;
                }
                
                if (templates.length > 0) {
                    displayTemplates(templates);
                } else {
                    grid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%); border-radius: 16px; border: 2px dashed #CBD5E1;">
                            <div style="font-size: 64px; margin-bottom: 16px;">üìù</div>
                            <h3 style="font-size: 20px; font-weight: 700; color: #1E293B; margin-bottom: 8px;">No Templates Yet</h3>
                            <p style="font-size: 15px; color: #64748B; margin-bottom: 24px; max-width: 400px; margin-left: auto; margin-right: auto;">Create your first professional email template above to get started!</p>
                            <button class="btn btn-primary" onclick="openCreateTemplateModal()" style="padding: 12px 24px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer;">
                                ‚ûï Create Your First Template
                            </button>
                        </div>
                    `;
                }

                // Also load default language if templates section is visible
                if (document.getElementById('templates-section') && document.getElementById('templates-section').style.display !== 'none') {
                    await loadDefaultLanguageForTemplates();
                }
            } catch (error) {
                console.error('Error loading templates:', error);
                showToast('Failed to load templates', 'error');
                const grid = document.getElementById('templatesGrid');
                if (grid) {
                    grid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 60px 20px; background: #FEF2F2; border-radius: 16px; border: 2px solid #FEE2E2;">
                            <div style="font-size: 64px; margin-bottom: 16px;">‚ùå</div>
                            <h3 style="font-size: 20px; font-weight: 700; color: #DC2626; margin-bottom: 8px;">Failed to Load Templates</h3>
                            <p style="font-size: 15px; color: #991B1B; margin-bottom: 24px;">Please refresh the page and try again.</p>
                            <button class="btn btn-secondary" onclick="loadUserTemplates()" style="padding: 12px 24px; background: white; color: #DC2626; border: 2px solid #FEE2E2; border-radius: 10px; font-weight: 600; cursor: pointer;">
                                üîÑ Retry
                            </button>
                        </div>
                    `;
                }
            }
        }

        // Load default language for templates section
        async function loadDefaultLanguageForTemplates() {
            try {
                const response = await fetch(`${API_URL}/users/me`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        const defaultLang = data.data.default_language || 'en';
                        const select = document.getElementById('defaultLanguageSelectTemplates');
                        if (select) {
                            select.value = defaultLang;
                        }
                    }
                }
            } catch (error) {
                console.error('Error loading default language:', error);
            }
        }

        // Display templates in grid
        function displayTemplates(templates) {
            const grid = document.getElementById('templatesGrid');
            
            if (templates.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-icon">üìù</div>
                        <p style="font-size: 16px; margin-bottom: 16px;">No templates yet</p>
                        <button class="btn btn-primary" onclick="openCreateTemplateModal()">
                            Create Your First Template
                        </button>
                    </div>
                `;
                return;
            }

            grid.innerHTML = templates.map(template => {
                const typeName = template.customer_type === 'retail' ? 'Retail' : template.customer_type === 'wholesale' ? 'Wholesale' : 'Advocates';
                const langName = getLanguageName(template.language) || template.language.toUpperCase();
                
                return `
                    <div class="template-card" style="background: white; padding: 20px; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 2px solid #E2E8F0; transition: all 0.3s;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                            <div>
                                <span class="badge" style="padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; text-transform: uppercase; background: ${template.customer_type === 'retail' ? '#FEF3C7' : template.customer_type === 'wholesale' ? '#DBEAFE' : '#E9D5FF'}; color: ${template.customer_type === 'retail' ? '#92400E' : template.customer_type === 'wholesale' ? '#1E40AF' : '#6B21A8'};">
                                    ${typeName}
                                </span>
                                <span class="badge" style="margin-left: 8px; padding: 6px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; background: #10B981; color: white;">
                                    ${langName}
                                </span>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button class="btn-sm" onclick="editTemplate('${template.id}')" style="padding: 6px 12px; background: #F8FAFC; border: 1px solid #E2E8F0; border-radius: 6px; cursor: pointer; font-size: 12px;">‚úèÔ∏è Edit</button>
                                <button class="btn-sm" onclick="deleteTemplate('${template.id}')" style="padding: 6px 12px; background: #FEF2F2; border: 1px solid #FEE2E2; color: #DC2626; border-radius: 6px; cursor: pointer; font-size: 12px;">üóëÔ∏è Delete</button>
                            </div>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <strong style="color: #1E293B; font-size: 13px;">Subject:</strong>
                            <p style="color: #64748B; font-size: 12px; margin-top: 4px; word-break: break-word;">${(template.subject || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').substring(0, 60)}${template.subject && template.subject.length > 60 ? '...' : ''}</p>
                        </div>
                        <div>
                            <strong style="color: #1E293B; font-size: 13px;">Body:</strong>
                            <p style="color: #64748B; font-size: 12px; margin-top: 4px; word-break: break-word; max-height: 60px; overflow: hidden;">${(template.body || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').substring(0, 100)}${template.body && template.body.length > 100 ? '...' : ''}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Open create template modal
        function openCreateTemplateModal() {
            // Create modal for template creation
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.id = 'createTemplateModal';
            modal.style.cssText = 'display:block; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeCreateTemplateModal()" style="position: absolute; width: 100%; height: 100%;"></div>
                <div class="modal-content" style="position: relative; background: white; margin: 5% auto; padding: 0; border-radius: 16px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                    <div class="modal-header" style="padding: 24px; border-bottom: 2px solid #E2E8F0;">
                        <h3 style="margin: 0; color: #1E293B;">‚ûï Create Email Template</h3>
                        <button onclick="closeCreateTemplateModal()" style="background: none; border: none; font-size: 28px; color: #64748B; cursor: pointer;">&times;</button>
                    </div>
                    <div class="modal-body" style="padding: 24px;">
                        <div class="form-group">
                            <label>Customer Type *</label>
                            <select id="newTemplateType" style="padding: 12px; border: 2px solid #E2E8F0; border-radius: 8px; font-size: 14px; width: 100%;">
                                <option value="retail">Retail Customer</option>
                                <option value="wholesale">Wholesale Customer</option>
                                <option value="advocates">Wellness Advocate</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Language *</label>
                            <select id="newTemplateLang" style="padding: 12px; border: 2px solid #E2E8F0; border-radius: 8px; font-size: 14px; width: 100%;">
                                <option value="en">English</option>
                                <option value="it">Italian</option>
                                <option value="fr">French</option>
                                <option value="es">Spanish</option>
                                <option value="de">German</option>
                                <option value="pl">Polish</option>
                                <option value="bg">Bulgarian</option>
                                <option value="hu">Hungarian</option>
                                <option value="cs">Czech</option>
                                <option value="sk">Slovak</option>
                                <option value="ro">Romanian</option>
                                <option value="hr">Croatian</option>
                                <option value="sr">Serbian</option>
                                <option value="ru">Russian</option>
                                <option value="uk">Ukrainian</option>
                                <option value="pt">Portuguese</option>
                                <option value="nl">Dutch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Subject *</label>
                            <input type="text" id="newTemplateSubject" placeholder="Email subject..." style="padding: 12px; border: 2px solid #E2E8F0; border-radius: 8px; font-size: 14px; width: 100%;">
                            <small style="color: #64748B; margin-top: 4px; display: block;">Use {{name}}, {{customer_type}}, {{country}} for personalization</small>
                        </div>
                        <div class="form-group">
                            <label>Message *</label>
                            <textarea id="newTemplateBody" rows="10" placeholder="Email message..." style="padding: 12px; border: 2px solid #E2E8F0; border-radius: 8px; font-size: 14px; width: 100%; resize: vertical;"></textarea>
                            <small style="color: #64748B; margin-top: 4px; display: block;">Use {{name}}, {{customer_type}}, {{country}} for personalization</small>
                        </div>
                    </div>
                    <div class="modal-footer" style="padding: 24px; border-top: 2px solid #E2E8F0; display: flex; gap: 12px; justify-content: flex-end;">
                        <button class="btn-primary" onclick="saveNewTemplate()" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer;">üíæ Save Template</button>
                        <button class="btn-cancel" onclick="closeCreateTemplateModal()" style="background: none; color: #64748B; border: none; padding: 12px 24px; font-weight: 600; cursor: pointer;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Close create template modal
        function closeCreateTemplateModal() {
            const modal = document.getElementById('createTemplateModal');
            if (modal) {
                modal.remove();
            }
        }

        // Save new template (works from both Templates section and modal)
        async function saveNewTemplate() {
            console.log('üîµ Saving new template...');
            
            // Try both IDs (for section form and modal form)
            const typeEl = document.getElementById('newTemplateType');
            const langEl = document.getElementById('newTemplateLanguage') || document.getElementById('newTemplateLang');
            const subjectEl = document.getElementById('newTemplateSubject');
            const bodyEl = document.getElementById('newTemplateBody');

            console.log('Form elements:', { typeEl: !!typeEl, langEl: !!langEl, subjectEl: !!subjectEl, bodyEl: !!bodyEl });

            if (!typeEl || !langEl || !subjectEl || !bodyEl) {
                console.error('‚ùå Missing form elements');
                showToast('Template form not found. Please fill in the form.', 'error');
                return;
            }

            const type = typeEl.value;
            const lang = langEl.value;
            const subject = subjectEl.value.trim();
            const body = bodyEl.value.trim();

            console.log('Form values:', { type, lang, subject: subject.substring(0, 50), body: body.substring(0, 50) });

            if (!type || !lang || !subject || !body) {
                showToast('All fields are required', 'error');
                return;
            }

            // Disable save button and show loading
            const saveBtn = event?.target || document.querySelector('button[onclick="saveNewTemplate()"]');
            const originalText = saveBtn?.innerHTML || 'üíæ Save Template';
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<span class="spinner" style="width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; display: inline-block; animation: spin 0.8s linear infinite; margin-right: 8px;"></span> Saving...';
            }

            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    showToast('Please log in', 'error');
                    if (saveBtn) {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = originalText;
                    }
                    return;
                }

                console.log('üîµ Sending API request...');
                const response = await fetch(`${API_URL}/templates`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customer_type: type,
                        language: lang,
                        subject: subject,
                        body: body
                    })
                });

                console.log('Response status:', response.status);
                const data = await response.json();
                console.log('Save template response:', data);

                if (response.ok && data.success) {
                    showToast('‚úÖ Template saved successfully!', 'success');
                    closeCreateTemplateModal();
                    clearTemplateForm();
                    await loadUserTemplates();
                } else {
                    throw new Error(data.error || data.message || 'Failed to save template');
                }
            } catch (error) {
                console.error('‚ùå Save template error:', error);
                showToast(error.message || 'Failed to save template', 'error');
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                }
            }
        }

        // Clear template form
        function clearTemplateForm() {
            const typeEl = document.getElementById('newTemplateType');
            const langEl = document.getElementById('newTemplateLanguage') || document.getElementById('newTemplateLang');
            const subjectEl = document.getElementById('newTemplateSubject');
            const bodyEl = document.getElementById('newTemplateBody');

            if (typeEl) typeEl.value = 'retail';
            if (langEl) langEl.value = 'en';
            if (subjectEl) subjectEl.value = '';
            if (bodyEl) bodyEl.value = '';
        }

        // Edit template
        async function editTemplate(templateId) {
            try {
                const response = await fetch(`${API_URL}/templates`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error('Failed to load templates');

                const data = await response.json();
                const template = data.data.find(t => t.id === templateId);

                if (!template) {
                    showToast('Template not found', 'error');
                    return;
                }

                // Pre-fill create modal with template data
                openCreateTemplateModal();
                setTimeout(() => {
                    document.getElementById('newTemplateType').value = template.customer_type;
                    document.getElementById('newTemplateLang').value = template.language;
                    document.getElementById('newTemplateSubject').value = template.subject;
                    document.getElementById('newTemplateBody').value = template.body;
                    
                    // Change save button to update
                    const saveBtn = document.querySelector('#createTemplateModal .btn-primary');
                    saveBtn.onclick = () => updateTemplate(templateId);
                    saveBtn.textContent = 'üíæ Update Template';
                }, 100);
            } catch (error) {
                console.error('Edit template error:', error);
                showToast('Failed to load template', 'error');
            }
        }

        // Update template
        async function updateTemplate(templateId) {
            const type = document.getElementById('newTemplateType').value;
            const lang = document.getElementById('newTemplateLang').value;
            const subject = document.getElementById('newTemplateSubject').value.trim();
            const body = document.getElementById('newTemplateBody').value.trim();

            if (!type || !lang || !subject || !body) {
                showToast('All fields are required', 'error');
                return;
            }

            try {
                // Delete old and create new (or use PUT if endpoint exists)
                const response = await fetch(`${API_URL}/templates`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customer_type: type,
                        language: lang,
                        subject: subject,
                        body: body
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast('‚úÖ Template updated successfully!', 'success');
                    closeCreateTemplateModal();
                    await loadUserTemplates();
                } else {
                    throw new Error(data.error || 'Failed to update template');
                }
            } catch (error) {
                console.error('Update template error:', error);
                showToast(error.message || 'Failed to update template', 'error');
            }
        }

        // Delete template
        async function deleteTemplate(templateId) {
            if (!confirm('Are you sure you want to delete this template?')) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/templates/${templateId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast('‚úÖ Template deleted', 'success');
                    await loadUserTemplates();
                } else {
                    throw new Error(data.error || 'Failed to delete template');
                }
            } catch (error) {
                console.error('Delete template error:', error);
                showToast(error.message || 'Failed to delete template', 'error');
            }
        }

        // Filter templates
        function filterTemplates() {
            // This will be called when filters change
            loadUserTemplates();
        }

        // Update default language
        async function updateDefaultLanguage() {
            const lang = document.getElementById('defaultLanguageSelect').value;
            
            try {
                const response = await fetch(`${API_URL}/users/update-default-language`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ default_language: lang })
                });

                if (response.ok) {
                    showToast('‚úÖ Default language updated', 'success');
                } else {
                    throw new Error('Failed to update default language');
                }
            } catch (error) {
                console.error('Update default language error:', error);
                showToast('Failed to update default language', 'error');
            }
        }

        // Update default language from templates section
        async function updateDefaultLanguageFromTemplates() {
            const lang = document.getElementById('defaultLanguageSelectTemplates').value;
            
            try {
                const response = await fetch(`${API_URL}/users/update-default-language`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ default_language: lang })
                });

                if (response.ok) {
                    showToast('‚úÖ Default language updated', 'success');
                    // Also update the settings page selector if it exists
                    const settingsSelect = document.getElementById('defaultLanguageSelect');
                    if (settingsSelect) {
                        settingsSelect.value = lang;
                    }
                } else {
                    throw new Error('Failed to update default language');
                }
            } catch (error) {
                console.error('Update default language error:', error);
                showToast('Failed to update default language', 'error');
            }
        }

        // Load default language on settings page load
        async function loadUserSettings() {
            try {
                const response = await fetch(`${API_URL}/users/me`, {
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        if (data.data.default_language) {
                            document.getElementById('defaultLanguageSelect').value = data.data.default_language;
                        }
                    }
                }
            } catch (error) {
                console.error('Load settings error:', error);
            }
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function selectAllCustomers() {
            document.querySelectorAll('.customer-checkbox').forEach(cb => cb.checked = true);
        }

        function deselectAllCustomers() {
            document.querySelectorAll('.customer-checkbox').forEach(cb => cb.checked = false);
        }

        function proceedToSend() {
            const selected = Array.from(document.querySelectorAll('.customer-checkbox:checked')).length;
            document.getElementById('selectedCount').textContent = selected;

            document.getElementById('machineStep3').style.display = 'none';
            document.getElementById('machineStep4').style.display = 'block';
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step3').classList.add('completed');
            document.getElementById('step4').classList.add('active');
        }

        let selectedTemplateType = 'retail';

        function selectTemplateType(type) {
            selectedTemplateType = type;
            document.querySelectorAll('#machineStep4 .type-option').forEach(opt => opt.classList.remove('selected'));
            event.target.closest('.type-option').classList.add('selected');
        }

        function previewEmail() {
            // Get selected customers
            const selectedCheckboxes = Array.from(document.querySelectorAll('.customer-checkbox:checked'));
            const selectedIndices = selectedCheckboxes.map(cb => parseInt(cb.dataset.index));
            const selectedCustomers = selectedIndices.map(i => extractedData[i]).filter(c => c);

            if (selectedCustomers.length === 0) {
                showToast('Please select at least one customer', 'error');
                return;
            }

            // Get subject and body
            const subject = document.getElementById('sendSubject').value;
            const body = document.getElementById('sendBody').value;

            if (!subject || !body) {
                showToast('Please fill in subject and body', 'error');
                return;
            }

            // Get user info for personalization
            const userName = localStorage.getItem('userName') || 'Your Advocate';

            // Use first customer for preview
            const previewCustomer = selectedCustomers[0];
            const firstName = previewCustomer.name.split(' ')[0];
            const fullName = previewCustomer.name;

            // Replace variables in subject and body
            const previewSubject = subject
                .replace(/\{\{firstname\}\}/g, firstName)
                .replace(/\{\{fullname\}\}/g, fullName)
                .replace(/\{\{email\}\}/g, previewCustomer.email)
                .replace(/\{\{country\}\}/g, previewCustomer.country || '')
                .replace(/\{\{your-name\}\}/g, userName)
                .replace(/\{\{your-phone\}\}/g, '');

            const previewBody = body
                .replace(/\{\{firstname\}\}/g, firstName)
                .replace(/\{\{fullname\}\}/g, fullName)
                .replace(/\{\{email\}\}/g, previewCustomer.email)
                .replace(/\{\{country\}\}/g, previewCustomer.country || '')
                .replace(/\{\{your-name\}\}/g, userName)
                .replace(/\{\{your-phone\}\}/g, '');

            // Show preview modal
            showEmailPreviewModal({
                subject: previewSubject,
                body: previewBody,
                customer: previewCustomer,
                totalCustomers: selectedCustomers.length,
                onSend: () => {
                    // Close preview and send
                    document.querySelector('.email-preview-modal')?.remove();
                    sendEmails();
                },
                onCancel: () => {
                    document.querySelector('.email-preview-modal')?.remove();
                }
            });
        }

        function showEmailPreviewModal(options) {
            const { subject, body, customer, totalCustomers, onSend, onCancel } = options;

            const modal = document.createElement('div');
            modal.className = 'modal-overlay email-preview-modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3>üìß Email Preview</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 20px; padding: 12px; background: #F8FAFC; border-radius: 8px;">
                            <strong>To:</strong> ${customer.email}<br>
                            <strong>Customer:</strong> ${customer.name}<br>
                            <strong>Total recipients:</strong> ${totalCustomers} customer${totalCustomers > 1 ? 's' : ''}
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1E293B;">Subject:</label>
                            <div style="padding: 12px; background: white; border: 1px solid #E2E8F0; border-radius: 8px; color: #1E293B;">
                                ${subject}
                            </div>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #1E293B;">Body:</label>
                            <div style="padding: 16px; background: white; border: 1px solid #E2E8F0; border-radius: 8px; color: #1E293B; white-space: pre-wrap; line-height: 1.6; max-height: 400px; overflow-y: auto;">
                                ${body}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="(${onCancel.toString()})()">Cancel</button>
                        <button class="btn btn-primary" onclick="(${onSend.toString()})()">‚úâÔ∏è Send to ${totalCustomers} Customer${totalCustomers > 1 ? 's' : ''}</button>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close on ESC
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEsc);
                    onCancel();
                }
            };
            document.addEventListener('keydown', handleEsc);

            // Close on overlay click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                    onCancel();
                }
            });
        }

        async function sendEmails() {
            try {
                // Get selected customers
                const selectedCheckboxes = Array.from(document.querySelectorAll('.customer-checkbox:checked'));
                const selectedIndices = selectedCheckboxes.map(cb => parseInt(cb.dataset.index));
                const selectedCustomers = selectedIndices.map(i => extractedData[i]).filter(c => c);

                if (selectedCustomers.length === 0) {
                    showToast('Please select at least one customer', 'error');
                    return;
                }

                // Get template type
                const templateType = selectedTemplateType;

                // Get subject and body
                const subject = document.getElementById('sendSubject').value;
                const body = document.getElementById('sendBody').value;

                if (!subject || !body) {
                    showToast('Please fill in subject and body', 'error');
                    return;
                }

                // Disable button and show loading
                const sendBtn = document.querySelector('#machineStep4 .btn-success');
                const originalText = sendBtn.innerHTML;
                sendBtn.disabled = true;
                sendBtn.innerHTML = '<span class="spinner"></span> Sending emails...';

                let originalTextForError = originalText;

                // Send emails
                const response = await fetch(`${API_URL}/emails/send`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        customer_ids: selectedCustomers.map(c => c.id),
                        template_type: templateType,
                        language: 'en',
                        subject: subject,
                        body: body
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast(`Successfully sent ${data.data.success} emails!`, 'success');
                    
                    // Reset wizard
                    setTimeout(() => {
                        document.getElementById('machineStep4').style.display = 'none';
                        document.getElementById('machineStep1').style.display = 'block';
                        document.querySelectorAll('.wizard-step').forEach(step => {
                            step.classList.remove('active', 'completed');
                        });
                        document.getElementById('step1').classList.add('active');
                        document.getElementById('machineFileInput').value = '';
                        extractedData = [];
                    }, 2000);
                } else {
                    throw new Error(data.message || data.error || 'Failed to send emails');
                }
            } catch (error) {
                console.error('Send emails error:', error);
                showToast(error.message || 'Failed to send emails. Please try again.', 'error');
                
                // Re-enable button
                const sendBtn = document.querySelector('#machineStep4 .btn-success');
                sendBtn.disabled = false;
                sendBtn.innerHTML = originalTextForError || '‚úâÔ∏è Send Follow-Up Emails';
            }
        }

        function logout() {
            showConfirmationModal({
                title: 'Logout',
                message: 'Are you sure you want to logout?',
                confirmText: 'Logout',
                cancelText: 'Cancel',
                danger: false,
                onConfirm: () => {
                    localStorage.clear();
                    if (isProduction) {
                        window.location.href = 'https://networkfollowup.netlify.app/login.html';
                    } else {
                        window.location.href = 'login.html';
                    }
                },
                onCancel: () => {}
            });
        }

        // Add Customer Modal with Business Card OCR
        function openAddCustomerModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'addCustomerModal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>‚ûï Add Customer</h3>
                        <button class="modal-close" onclick="closeModal('addCustomerModal')">√ó</button>
                    </div>
                    <div class="modal-body">
                        <div style="margin-bottom: 24px; padding: 16px; background: #F0F9FF; border-radius: 8px; border: 2px dashed #3B82F6;">
                            <div style="text-align: center; margin-bottom: 12px;">
                                <div style="font-size: 48px;">üìá</div>
                                <h4 style="margin: 8px 0; color: #1E293B;">Upload Business Card</h4>
                                <p style="color: #64748B; font-size: 14px; margin-bottom: 12px;">Take a photo or upload an image of a business card</p>
                                <input type="file" id="businessCardInput" accept="image/*" style="display: none;" onchange="uploadBusinessCard(event)">
                                <button class="btn btn-primary" onclick="document.getElementById('businessCardInput').click()">
                                    üì∑ Upload Business Card
                                </button>
                            </div>
                        </div>
                        
                        <div style="border-top: 1px solid #E2E8F0; padding-top: 24px; margin-top: 24px;">
                            <h4 style="margin-bottom: 16px; color: #1E293B;">Or Enter Manually</h4>
                            <form id="addCustomerForm" onsubmit="saveCustomer(event)">
                                <div class="form-group">
                                    <label>Full Name *</label>
                                    <input type="text" id="customerName" required placeholder="John Smith">
                                </div>
                                <div class="form-group">
                                    <label>Email *</label>
                                    <input type="email" id="customerEmail" required placeholder="john@example.com">
                                </div>
                                <div class="form-group">
                                    <label>Phone</label>
                                    <input type="tel" id="customerPhone" placeholder="+1 234 567 8900">
                                </div>
                                <div class="form-group">
                                    <label>Company</label>
                                    <input type="text" id="customerCompany" placeholder="Company Name">
                                </div>
                                <div class="form-group">
                                    <label>Role/Title</label>
                                    <input type="text" id="customerRole" placeholder="Job Title">
                                </div>
                                <div class="form-group">
                                    <label>Customer Type *</label>
                                    <select id="customerType" required>
                                        <option value="retail">üõçÔ∏è Retail</option>
                                        <option value="wholesale">üíº Wholesale</option>
                                        <option value="advocates">‚≠ê Advocates</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Country Code</label>
                                    <input type="text" id="customerCountry" placeholder="USA" maxlength="3" style="text-transform: uppercase;">
                                </div>
                                <div style="display: flex; gap: 12px; margin-top: 24px;">
                                    <button type="submit" class="btn btn-primary" style="flex: 1;">Save Customer</button>
                                    <button type="button" class="btn btn-secondary" onclick="closeModal('addCustomerModal')" style="flex: 1;">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function uploadBusinessCard(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Show loading state
            const modal = document.getElementById('addCustomerModal');
            const uploadBtn = modal.querySelector('.btn-primary');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<span class="spinner"></span> Extracting data...';

            try {
                const formData = new FormData();
                formData.append('image', file);

                const response = await fetch(`${API_URL}/uploads/ocr`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    // Auto-fill form with extracted data
                    const extracted = data.data;
                    if (extracted.name) document.getElementById('customerName').value = extracted.name;
                    if (extracted.email) document.getElementById('customerEmail').value = extracted.email;
                    if (extracted.phone) document.getElementById('customerPhone').value = extracted.phone;
                    if (extracted.company) document.getElementById('customerCompany').value = extracted.company;
                    if (extracted.role) document.getElementById('customerRole').value = extracted.role;

                    showToast('‚úÖ Business card data extracted! Review and save.', 'success');
                } else {
                    throw new Error(data.message || data.error || 'Failed to extract data');
                }
            } catch (error) {
                console.error('Business card OCR error:', error);
                showToast(error.message || 'Failed to extract data from image. Please enter manually.', 'error');
            } finally {
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = originalText;
                // Reset file input
                event.target.value = '';
            }
        }

        async function saveCustomer(event) {
            event.preventDefault();

            const customerData = {
                full_name: document.getElementById('customerName').value.trim(),
                email: document.getElementById('customerEmail').value.trim().toLowerCase(),
                customer_type: document.getElementById('customerType').value,
                country_code: document.getElementById('customerCountry').value.trim().toUpperCase() || 'USA'
            };

            if (!customerData.full_name || !customerData.email) {
                showToast('Please fill in required fields', 'error');
                return;
            }

            const submitBtn = event.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span> Saving...';

            try {
                const response = await fetch(`${API_URL}/customers`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify(customerData)
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast('‚úÖ Customer added successfully!', 'success');
                    closeModal('addCustomerModal');
                    
                    // Reload customers list
                    await loadCustomers();
                    
                    // Reset form
                    document.getElementById('addCustomerForm').reset();
                } else {
                    throw new Error(data.message || data.error || 'Failed to save customer');
                }
            } catch (error) {
                console.error('Save customer error:', error);
                showToast(error.message || 'Failed to save customer. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        // Customer list management
        let selectedCustomerIds = [];

        function toggleSelectAllCustomers(checkbox) {
            const checkboxes = document.querySelectorAll('.customer-checkbox');
            checkboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateSelectedCustomers();
        }

        function updateSelectedCustomers() {
            const checkboxes = document.querySelectorAll('.customer-checkbox:checked');
            selectedCustomerIds = Array.from(checkboxes).map(cb => cb.dataset.customerId);
        }

        // Modify Customer Modal
        async function openModifyCustomerModal(customerId) {
            try {
                const response = await fetch(`${API_URL}/customers/${customerId}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('Failed to load customer');
                }

                const data = await response.json();
                const customer = data.data;

                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'modifyCustomerModal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3>Edit Client</h3>
                            <button class="modal-close" onclick="closeModal('modifyCustomerModal')">√ó</button>
                        </div>
                        <div class="modal-body">
                            <form id="modifyCustomerForm" onsubmit="saveModifiedCustomer(event, '${customerId}')">
                                <div class="form-group">
                                    <label>Full Name *</label>
                                    <input type="text" id="modifyFullName" value="${customer.full_name || ''}" required placeholder="John Smith">
                                </div>
                                <div class="form-group">
                                    <label>Email *</label>
                                    <input type="email" id="modifyEmail" value="${customer.email || ''}" required placeholder="john@email.com">
                                </div>
                                <div class="form-group">
                                    <label>Client Type *</label>
                                    <select id="modifyCustomerType" required>
                                        <option value="retail" ${customer.customer_type === 'retail' ? 'selected' : ''}>Retail</option>
                                        <option value="wholesale" ${customer.customer_type === 'wholesale' ? 'selected' : ''}>Wholesale</option>
                                        <option value="advocates" ${customer.customer_type === 'advocates' ? 'selected' : ''}>Advocates</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Country</label>
                                    <input type="text" id="modifyCountry" value="${customer.country_code || ''}" placeholder="USA, DEU, ITA, etc.">
                                </div>
                                <div class="modal-footer" style="margin-top: 24px;">
                                    <button type="button" class="btn btn-secondary" onclick="closeModal('modifyCustomerModal')">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error opening modify modal:', error);
                showToast('Error loading client', 'error');
            }
        }

        async function saveModifiedCustomer(event, customerId) {
            event.preventDefault();
            try {
                const fullName = document.getElementById('modifyFullName').value;
                const email = document.getElementById('modifyEmail').value;
                const customerType = document.getElementById('modifyCustomerType').value;
                const country = document.getElementById('modifyCountry').value;

                const response = await fetch(`${API_URL}/customers/${customerId}`, {
                    method: 'PUT',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        full_name: fullName,
                        email: email,
                        customer_type: customerType,
                        country_code: country
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast('‚úÖ Client updated successfully!', 'success');
                    closeModal('modifyCustomerModal');
                    await loadCustomers();
                } else {
                    throw new Error(data.message || data.error || 'Failed to update customer');
                }
            } catch (error) {
                console.error('Error saving customer:', error);
                showToast(error.message || 'Error saving changes', 'error');
            }
        }

        // Message Customer Modal
        async function openMessageCustomerModal(customerId) {
            try {
                const response = await fetch(`${API_URL}/customers/${customerId}`, {
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    throw new Error('Failed to load customer');
                }

                const data = await response.json();
                const customer = data.data;

                // Get template based on customer type and country
                const languageMap = {
                    'USA': 'en', 'GBR': 'en', 'CAN': 'en', 'AUS': 'en',
                    'ITA': 'it',
                    'DEU': 'de', 'AUT': 'de', 'CHE': 'de',
                    'FRA': 'fr', 'BEL': 'fr',
                    'ESP': 'es', 'MEX': 'es', 'ARG': 'es'
                };
                const language = languageMap[customer.country_code] || 'en';
                const customerType = customer.customer_type || 'retail';

                // Fetch template from API
                let templateSubject = 'Your doTERRA 25% Discount is Waiting!';
                let templateBody = `Hi {{firstname}},

I'm {{your-name}}, your official doTERRA Wellness Advocate...

Best regards,
{{your-name}}`;

                try {
                    const templateResponse = await fetch(`${API_URL}/emails/templates?type=${customerType}&language=${language}`, {
                        headers: getAuthHeaders()
                    });
                    if (templateResponse.ok) {
                        const templateData = await templateResponse.json();
                        if (templateData.success && templateData.data) {
                            templateSubject = templateData.data.subject || templateSubject;
                            templateBody = templateData.data.body || templateBody;
                        }
                    }
                } catch (err) {
                    console.warn('Could not load template, using default');
                }

                // Personalize template
                const firstName = (customer.full_name || '').split(' ')[0];
                const userName = localStorage.getItem('userName') || 'Your Advocate';
                const personalizedSubject = templateSubject
                    .replace(/\{\{firstname\}\}/g, firstName)
                    .replace(/\{\{fullname\}\}/g, customer.full_name || '')
                    .replace(/\{\{your-name\}\}/g, userName);
                const personalizedBody = templateBody
                    .replace(/\{\{firstname\}\}/g, firstName)
                    .replace(/\{\{fullname\}\}/g, customer.full_name || '')
                    .replace(/\{\{email\}\}/g, customer.email || '')
                    .replace(/\{\{country\}\}/g, customer.country_code || '')
                    .replace(/\{\{your-name\}\}/g, userName);

                const modal = document.createElement('div');
                modal.className = 'modal-overlay';
                modal.id = 'messageCustomerModal';
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>Send Message</h3>
                            <button class="modal-close" onclick="closeModal('messageCustomerModal')">√ó</button>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 16px; padding: 12px; background: #F0F9FF; border-radius: 8px;">
                                <strong>Recipient:</strong> ${customer.full_name} (${customer.email})
                            </div>
                            <form id="messageCustomerForm" onsubmit="sendCustomerMessage(event, '${customerId}')">
                                <div class="form-group">
                                    <label>Subject *</label>
                                    <input type="text" id="messageSubject" value="${personalizedSubject}" required>
                                </div>
                                <div class="form-group">
                                    <label>Message *</label>
                                    <textarea id="messageBody" rows="10" required style="width: 100%; padding: 12px; border: 1px solid #E2E8F0; border-radius: 8px; font-family: inherit; resize: vertical;">${personalizedBody}</textarea>
                                    <small style="color: #64748B; margin-top: 4px; display: block;">
                                        Available variables: {{firstname}}, {{fullname}}, {{email}}, {{country}}, {{your-name}}
                                    </small>
                                </div>
                                <div class="modal-footer" style="margin-top: 24px;">
                                    <button type="button" class="btn btn-secondary" onclick="closeModal('messageCustomerModal')">Cancel</button>
                                    <button type="submit" class="btn btn-primary">‚úâÔ∏è Send Message</button>
                                </div>
                            </form>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error opening message modal:', error);
                showToast('Error loading client', 'error');
            }
        }

        async function sendCustomerMessage(event, customerId) {
            event.preventDefault();
            try {
                const subject = document.getElementById('messageSubject').value;
                const body = document.getElementById('messageBody').value;

                const response = await fetch(`${API_URL}/emails/send`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        customer_ids: [customerId],
                        template_type: 'retail', // Will be determined from customer
                        subject: subject,
                        body: body
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showToast('‚úÖ Message sent successfully!', 'success');
                    closeModal('messageCustomerModal');
                    await loadCustomers();
                } else {
                    throw new Error(data.message || data.error || 'Failed to send message');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showToast(error.message || 'Error sending message', 'error');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            // Check auth first
            if (!checkAuth()) {
                console.error('‚ùå Authentication check failed on page load');
                return;
            }

            // Verify token exists
            const token = localStorage.getItem('authToken');
            if (!token) {
                console.error('‚ùå No auth token in localStorage');
                showToast('Authentication failed - Please log in again', 'error');
                setTimeout(() => {
                    if (isProduction) {
                        window.location.href = 'https://networkfollowup.netlify.app/login.html';
                    } else {
                        window.location.href = 'login.html';
                    }
                }, 2000);
                return;
            }

            console.log('‚úÖ Auth token found, loading dashboard...');
            loadDashboard();
            
            // Add ripple effects to all buttons
            document.querySelectorAll('.btn').forEach(btn => {
                addRippleEffect(btn);
            });
            
            // Add keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // ESC to close modals
                if (e.key === 'Escape') {
                    const modal = document.querySelector('.modal-overlay');
                    if (modal) {
                        modal.remove();
                    }
                }
            });
        });
    </script>

    <!-- Email Preview & Edit Modal -->
    <div id="emailModal" class="modal">
        <div class="modal-overlay" onclick="closeEmailModal()"></div>
        <div class="modal-content modal-large">
            <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #eee;">
                <h3 style="margin: 0; color: #1E293B;">üìß Email Preview & Edit</h3>
                <button class="close-btn" onclick="closeEmailModal()" style="background: none; border: none; font-size: 28px; cursor: pointer; color: #999;">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">Customer Name:</label>
                        <input type="text" id="modalCustomerName" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">Email:</label>
                        <input type="email" id="modalCustomerEmail" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" readonly>
                    </div>
                </div>
                
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">Type:</label>
                        <select id="modalCustomerType" class="form-control" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                            <option value="retail">Retail</option>
                            <option value="wholesale">Wholesale</option>
                            <option value="advocate">Advocate</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">Language:</label>
                        <input type="text" id="modalCustomerLanguage" class="form-control" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: #f5f5f5;">
                    </div>
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">Subject:</label>
                    <input type="text" id="emailSubject" class="form-control" placeholder="Email subject..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;">
                </div>
                
                <div class="form-group" style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333;">Message:</label>
                    <textarea id="emailBody" class="form-control" rows="12" placeholder="Email message..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; resize: vertical;"></textarea>
                </div>
                
                <div id="templateStatusBadge" class="template-status" style="margin: 16px 0; padding: 12px; background: #f5f5f5; border-radius: 6px;"></div>
                
                <div class="variables-help" style="margin-top: 12px; padding: 12px; background: #E3F2FD; border-radius: 6px;">
                    <small style="color: #1E293B;">
                        <strong>Variables:</strong>
                        <code style="background: white; padding: 2px 6px; border-radius: 3px; margin: 0 4px; font-size: 12px;">{{name}}</code>
                        <code style="background: white; padding: 2px 6px; border-radius: 3px; margin: 0 4px; font-size: 12px;">{{customer_type}}</code>
                        <code style="background: white; padding: 2px 6px; border-radius: 3px; margin: 0 4px; font-size: 12px;">{{country}}</code>
                        <code style="background: white; padding: 2px 6px; border-radius: 3px; margin: 0 4px; font-size: 12px;">{{your_name}}</code>
                        <code style="background: white; padding: 2px 6px; border-radius: 3px; margin: 0 4px; font-size: 12px;">{{your_email}}</code>
                        <code style="background: white; padding: 2px 6px; border-radius: 3px; margin: 0 4px; font-size: 12px;">{{your_phone}}</code>
                        <code style="background: white; padding: 2px 6px; border-radius: 3px; margin: 0 4px; font-size: 12px;">{{company_name}}</code>
                    </small>
                </div>
            </div>
            
            <div class="modal-footer" style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; padding-top: 16px; border-top: 1px solid #eee;">
                <button class="btn-primary" onclick="sendEmailFromModal()" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üìß Send Email</button>
                <button class="btn-primary" onclick="saveEmailChanges()" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">üíæ Save Changes</button>
                <button class="btn-secondary" onclick="resetToTemplate()" style="background: #f5f5f5; color: #333; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">üîÑ Reset to Template</button>
                <button class="btn-cancel" onclick="closeEmailModal()" style="background: #f5f5f5; color: #333; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">Cancel</button>
            </div>
        </div>
    </div>
</body>
</html>
